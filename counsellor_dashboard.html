<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Counsellor Dashboard | Case Management</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root {
        --bg: #0f172a; --sidebar: #1e1b4b; --card-bg: #1e293b; 
        --primary: #8b5cf6; --secondary: #06b6d4; --accent: #f43f5e;
        --text-main: #f8fafc; --text-muted: #94a3b8; --border: #334155;
        --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
      }
      body { background-color: var(--bg); font-family: 'Nunito', sans-serif; color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden; }
      
      /* --- SIDEBAR --- */
      .sidebar { width: 280px; background: var(--sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding-top: 20px; overflow-y: auto;}
      .brand { padding: 0 20px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
      .brand h2 { margin: 0; font-size: 1.5rem; background: -webkit-linear-gradient(45deg, var(--secondary), var(--primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 900; }
      
      .nav-btn { background: transparent; color: var(--text-muted); border: none; text-align: left; padding: 15px 25px; font-size: 0.95rem; font-weight: bold; cursor: pointer; transition: 0.2s; border-left: 4px solid transparent; width: 100%; display: flex; align-items: center; gap: 10px; }
      .nav-btn:hover { background: rgba(255,255,255,0.05); color: white; }
      .nav-btn.active { background: rgba(139, 92, 246, 0.1); color: var(--primary); border-left-color: var(--primary); }

      /* --- MAIN LAYOUT & TOP HEADER --- */
      .main-wrapper { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
      
      .top-header { background: var(--card-bg); height: 70px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; padding: 0 40px; }
      .header-actions { display: flex; align-items: center; gap: 20px; }
      .site-link { color: var(--secondary); text-decoration: none; font-weight: bold; padding: 8px 15px; border-radius: 8px; background: rgba(6, 182, 212, 0.1); transition: 0.2s;}
      .site-link:hover { background: rgba(6, 182, 212, 0.2); }
      
      /* User Profile Dropdown */
      .profile-menu { position: relative; display: inline-block; }
      .avatar-btn { width: 45px; height: 45px; border-radius: 50%; border: 2px solid var(--primary); cursor: pointer; object-fit: cover; background: #000;}
      .dropdown-content { display: none; position: absolute; right: 0; background-color: var(--card-bg); min-width: 200px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.5); z-index: 100; border-radius: 12px; border: 1px solid var(--border); overflow: hidden; margin-top: 10px;}
      .dropdown-content a { color: var(--text-main); padding: 12px 16px; text-decoration: none; display: block; font-size: 0.9rem; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.05);}
      .dropdown-content a:hover { background-color: rgba(255,255,255,0.05); color: var(--primary); }
      .profile-menu.active .dropdown-content { display: block; }

      /* --- CONTENT AREA --- */
      .main-content { flex: 1; padding: 30px 40px; overflow-y: auto; position: relative;}
      .tab-content { display: none; animation: fadeIn 0.3s ease; }
      .tab-content.active { display: block; }
      
      .header-bar { margin-bottom: 30px; display: flex; justify-content: space-between; align-items: flex-end;}
      .header-bar h1 { margin: 0 0 5px 0; font-size: 1.8rem; }
      .header-bar p { margin: 0; color: var(--text-muted); }

      /* UI COMPONENTS */
      .card { background: var(--card-bg); padding: 25px; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
      .card h3 { margin-top: 0; color: white; border-bottom: 1px solid var(--border); padding-bottom: 10px; font-size: 1.2rem; display: flex; justify-content: space-between; align-items: center; }
      
      .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
      .kpi-box { background: linear-gradient(135deg, rgba(30,41,59,1) 0%, rgba(15,23,42,1) 100%); padding: 20px; border-radius: 12px; border: 1px solid var(--border); }
      .kpi-box h4 { margin:0 0 10px 0; color:var(--text-muted); font-size:0.85rem; text-transform:uppercase;}
      .kpi-box .val { font-size:2rem; font-weight:900; color:white; }
      
      .grid-3-1 { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; }
      .grid-2col { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }

      .form-group { margin-bottom: 15px; }
      .form-label { display: block; font-weight: 700; margin-bottom: 6px; color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase;}
      .form-input, .form-select, .form-textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.95rem; color: white; background: #0f172a; box-sizing: border-box; font-family: inherit;}
      .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--primary); outline: none; }
      .btn { background: linear-gradient(45deg, var(--primary), #a855f7); color: white; border: none; padding: 12px 25px; font-size: 1rem; font-weight: bold; border-radius: 8px; cursor: pointer; transition: 0.2s; }
      .btn:hover { opacity: 0.9; transform: translateY(-2px); }
      .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
      .btn-outline:hover { background: rgba(139, 92, 246, 0.1); }

      .data-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
      .data-table th, .data-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); }
      .data-table th { color: var(--text-muted); text-transform: uppercase; font-size: 0.8rem; }
      .data-table tr:hover { background: rgba(255,255,255,0.02); }

      .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }
      .badge-success { background: rgba(16, 185, 129, 0.2); color: var(--success); border: 1px solid var(--success);}
      .badge-warning { background: rgba(245, 158, 11, 0.2); color: var(--warning); border: 1px solid var(--warning);}
      .badge-danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); border: 1px solid var(--danger);}

      /* CASE LIST STYLING */
      .case-item { display: flex; align-items: center; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 12px; margin-bottom: 12px; border: 1px solid transparent; transition: 0.2s; }
      .case-item:hover { border-color: var(--primary); transform: translateX(5px); }
      .case-status { width: 12px; height: 12px; border-radius: 50%; margin-right: 15px; flex-shrink: 0;}
      .case-info { flex: 1; }
      .case-time { font-size: 0.8rem; color: var(--secondary); font-weight: bold; }

      /* CHAT STYLES */
      .chat-message { padding: 12px 18px; border-radius: 12px; margin-bottom: 12px; font-size: 0.95rem; max-width: 85%; line-height: 1.5;}
      .msg-me { background: var(--primary); color: white; margin-left: auto; border-bottom-right-radius: 0; box-shadow: 0 4px 10px rgba(139, 92, 246, 0.2);}
      .msg-them { background: rgba(255,255,255,0.05); color: white; margin-right: auto; border-bottom-left-radius: 0; border: 1px solid var(--border);}

      /* MODAL UI (UPGRADED) */
      .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
      .modal-content { background: var(--card-bg); width: 900px; max-width: 95%; max-height: 90vh; overflow-y: auto; padding: 30px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 20px 50px rgba(0,0,0,0.5); animation: fadeIn 0.3s ease;}
      
      .profile-360-header { display: flex; justify-content: space-between; border-bottom: 2px solid var(--primary); padding-bottom: 15px; margin-bottom: 20px;}
      .readiness-track { display: flex; gap: 5px; margin-top: 10px;}
      .readiness-box { flex: 1; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; position: relative;}
      .readiness-box.active { background: var(--success); box-shadow: 0 0 10px var(--success);}

      .avatar-wrapper { position: relative; width: 100px; height: 100px; margin-bottom: 15px; cursor: pointer; }
      .prof-avatar { width: 100%; height: 100%; border-radius: 50%; border: 3px solid var(--primary); object-fit: cover; background: #0f172a; transition: 0.3s;}
      .avatar-wrapper:hover .prof-avatar { opacity: 0.7; }
      .avatar-wrapper::after { content: 'üì∑'; position: absolute; bottom: 0; right: 0; background: var(--primary); border-radius: 50%; padding: 6px; font-size: 14px; border: 2px solid var(--sidebar); pointer-events: none;}

      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="modal-overlay" id="studentModal">
    <div class="modal-content">
        <div class="profile-360-header">
            <div>
                <h2 id="modalStuName" style="margin: 0 0 5px 0; color: white;">Student Name</h2>
                <span id="modalStuEmail" style="color: var(--text-muted); font-size: 0.9rem;">student@email.com</span>
                <div style="margin-top: 10px;">
                    <span class="badge" id="modalStuGrade">Grade --</span>
                    <span class="badge" id="modalStuStatus">Status</span>
                    <span class="badge" id="modalStuRisk">Risk</span>
                </div>
            </div>
            <button onclick="closeStudentModal()" style="background:transparent; border:none; color:var(--text-muted); font-size:1.8rem; cursor:pointer;">&times;</button>
        </div>
        
        <div class="grid-2col">
            <div>
                <div class="card" style="margin-bottom:20px; background:rgba(0,0,0,0.2);">
                    <h3 style="font-size:1rem; border-bottom:1px dashed var(--border);">üìä Academic & Career Alignment</h3>
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <span style="color:var(--text-muted); font-size:0.9rem;">Current Stream:</span>
                        <strong style="color:white;" id="modalStuStream">--</strong>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <span style="color:var(--text-muted); font-size:0.9rem;">Avg Marks:</span>
                        <strong style="color:white;" id="modalStuMarks">--%</strong>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <span style="color:var(--text-muted); font-size:0.9rem;">Top Subject:</span>
                        <strong style="color:var(--secondary);" id="modalStuStrong">--</strong>
                    </div>
                    <div style="background: rgba(139,92,246,0.1); border: 1px solid var(--primary); padding: 10px; border-radius: 8px; margin-top: 15px;">
                        <span style="display:block; font-size:0.8rem; color:var(--primary); text-transform:uppercase; font-weight:bold;">RIASEC Match Alert</span>
                        <span style="color:white; font-size:0.9rem;" id="modalStuMatchAlert">System calculating...</span>
                    </div>
                </div>

                <div class="card" style="margin-bottom:0; background:rgba(0,0,0,0.2);">
                    <h3 style="font-size:1rem; border-bottom:1px dashed var(--border);">üìà Clarity Growth Curve</h3>
                    <div style="height: 150px; width: 100%;">
                        <canvas id="modalClarityChart"></canvas>
                    </div>
                </div>
            </div>

            <div>
                <div class="card" style="margin-bottom:20px; background:rgba(0,0,0,0.2); border-top: 4px solid var(--success);">
                    <h3 style="font-size:1rem; border-bottom:none; margin-bottom:5px;">üß© Decision Readiness Stage</h3>
                    <div class="readiness-track">
                        <div class="readiness-box" id="r-stage-1" title="Exploration"></div>
                        <div class="readiness-box" id="r-stage-2" title="Comparison"></div>
                        <div class="readiness-box" id="r-stage-3" title="Shortlisting"></div>
                        <div class="readiness-box" id="r-stage-4" title="Finalizing"></div>
                        <div class="readiness-box" id="r-stage-5" title="Locked"></div>
                    </div>
                    <div style="display:flex; justify-content:space-between; font-size:0.75rem; color:var(--text-muted); margin-top:5px;">
                        <span>Exploring</span><span>Locked</span>
                    </div>
                </div>

                <div class="card" style="margin-bottom:0; background:rgba(0,0,0,0.2);">
                    <h3 style="font-size:1rem; border-bottom:1px dashed var(--border);">üìã Clinical Case Summary</h3>
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:0.9rem;">
                        <span style="color:var(--text-muted);">Total Sessions:</span>
                        <strong style="color:white;" id="modalSessionCount">0</strong>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px; font-size:0.9rem;">
                        <span style="color:var(--text-muted);">Parent Involvement:</span>
                        <strong style="color:var(--warning);" id="modalParentInv">Unknown</strong>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.05); border: 1px dashed var(--border); padding: 10px; border-radius: 8px; font-size: 0.85rem; color: var(--text-main); max-height: 150px; overflow-y:auto;" id="modalLastNote">
                        No previous session notes found.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="sidebar">
    <div class="brand">
        <h2>Career Intel</h2>
        <span style="color:var(--text-muted); padding-left:20px; font-size:0.75rem; letter-spacing: 1px;">CLINICAL PANEL</span>
    </div>
    <button class="nav-btn active" onclick="switchTab('tab-overview', this)">üè† Overview</button>
    <button class="nav-btn" onclick="switchTab('tab-queue', this)">üéì Student Queue</button>
    <button class="nav-btn" onclick="switchTab('tab-sessions', this)">üìÖ Session Manager</button>
    <button class="nav-btn" onclick="switchTab('tab-chat', this)">üí¨ Direct Chat</button>
    <button class="nav-btn" onclick="switchTab('tab-interventions', this)">üö® Interventions</button>
    <button class="nav-btn" onclick="switchTab('tab-resources', this)">üìö Resources</button>
    <div style="border-top: 1px solid var(--border); margin: 15px 20px;"></div>
    <button class="nav-btn" onclick="switchTab('tab-profile', this)">‚öôÔ∏è My Profile</button>
</div>

<div class="main-wrapper">
    <div class="top-header">
        <h2 style="margin:0; font-size:1.1rem; color:var(--text-muted);" id="headerTitle">Counselor Dashboard</h2>
        
        <div class="header-actions">
            <a href="index.html" class="site-link">üåê Live Website</a>
            
            <div class="profile-menu" id="profileDropdownBtn">
                <img src="https://ui-avatars.com/api/?name=Counsellor&background=8b5cf6&color=fff" class="avatar-btn" id="topAvatarImg" onclick="toggleDropdown()">
                <div class="dropdown-content">
                    <div style="padding: 15px; border-bottom: 1px solid var(--border); background:rgba(0,0,0,0.2);">
                        <strong id="dropName" style="color:white; display:block;">Counselor Name</strong>
                        <span id="dropEmail" style="font-size:0.8rem; color:var(--text-muted);">email@gmail.com</span>
                    </div>
                    <a href="#" onclick="switchTab('tab-profile', document.querySelectorAll('.nav-btn')[6]); toggleDropdown();">‚öôÔ∏è My Profile</a>
                    <a href="#" style="color:var(--danger);" onclick="logoutUser()">üö™ Secure Logout</a>
                </div>
            </div>
        </div>
    </div>

    <div class="main-content">
        
        <div id="tab-overview" class="tab-content active">
            <div class="header-bar">
                <div>
                    <h1>Counselor Command Center</h1>
                    <p id="currentDateDisplay">Date</p>
                </div>
            </div>

            <div class="kpi-grid">
                <div class="kpi-box" style="border-top: 3px solid var(--primary);"><h4>Assigned Students</h4><div class="val" id="kpiStudents">0</div></div>
                <div class="kpi-box" style="border-top: 3px solid var(--secondary);"><h4>Pending Requests</h4><div class="val" id="kpiPending">0</div></div>
                <div class="kpi-box" style="border-top: 3px solid var(--danger);"><h4>High Risk Flags</h4><div class="val" id="kpiRisk">0</div></div>
                <div class="kpi-box" style="border-top: 3px solid var(--success);"><h4>Confirmed Sessions</h4><div class="val" id="kpiConfirmed">0</div></div>
            </div>

            <div class="grid-3-1">
                <div>
                    <div class="card">
                        <h3>Appointment Requests & Queue</h3>
                        <div id="bookingRequestsContainer">
                            <div style="text-align:center; color:var(--text-muted); padding: 20px;">Scanning for incoming requests...</div>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="card" style="border-top: 4px solid var(--danger);">
                        <h3>System Alerts</h3>
                        <div style="font-size:0.9rem; color:var(--text-muted); line-height: 1.6;" id="alertBox">
                            <p style="text-align:center;">Monitoring system for clinical flags...</p>
                        </div>
                        
                        <div id="interventionSuggestionPanel" style="margin-top:20px; padding-top:15px; border-top:1px dashed var(--border); display:none;">
                            <span style="font-size:0.8rem; font-weight:bold; color:var(--primary); text-transform:uppercase;">üéØ Smart Suggestion</span>
                            <p id="interventionText" style="margin:5px 0; color:white; font-size:0.9rem;"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-queue" class="tab-content">
            <div class="header-bar">
                <div>
                    <h1>Student Queue</h1>
                    <p>Live database of all students assigned to your roster.</p>
                </div>
                <div style="display:flex; gap:10px;">
                    <select class="form-select" id="clinicalFilter" onchange="loadAssignedStudents()" style="width:180px;">
                        <option value="ALL">All Students</option>
                        <option value="RISK">High Risk Flags</option>
                        <option value="LOCKED">Career Locked</option>
                        <option value="PENDING">Needs Assessment</option>
                    </select>
                    <input type="text" id="studentSearchInput" class="form-input" placeholder="Search name..." style="width: 200px;" onkeyup="loadAssignedStudents()">
                </div>
            </div>

            <div class="card">
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Email</th>
                                <th>Grade</th>
                                <th>Assessment</th>
                                <th>Primary Flag</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="studentTableBody">
                            <tr><td colspan="6" style="text-align:center;">Loading assigned students...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-sessions" class="tab-content">
            <div class="header-bar"><h1>Session & Case Manager</h1><p>Set your availability for student bookings and log clinical notes.</p></div>
            <div class="grid-2col">
                
                <div class="card" style="border-top: 4px solid var(--secondary);">
                    <h3>Set Booking Availability</h3>
                    <p style="font-size:0.85rem; color:var(--text-muted); margin-top:-5px;">This will be displayed to students on their portal.</p>
                    
                    <div class="form-group">
                        <label class="form-label">Available Days</label>
                        <input type="text" class="form-input" placeholder="e.g. Mon, Wed, Fri" value="Mon, Wed, Fri">
                    </div>
                    <div class="grid-2col" style="gap:15px;">
                        <div class="form-group">
                            <label class="form-label">Start Time</label>
                            <input type="time" class="form-input" value="14:00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">End Time</label>
                            <input type="time" class="form-input" value="18:00">
                        </div>
                    </div>
                    <button class="btn" style="width: 100%;">Update Calendar</button>
                </div>

                <div class="card" style="border-top: 4px solid var(--primary);">
                    <h3>Log Structured Case Notes</h3>
                    <div class="form-group">
                        <select class="form-select" id="sessionStudentSelect">
                            <option value="">-- Select Student --</option>
                        </select>
                    </div>
                    
                    <div class="grid-2col" style="gap:15px;">
                        <div class="form-group">
                            <label class="form-label">Session Type</label>
                            <select class="form-select" id="logType">
                                <option value="Exploration">Exploration</option>
                                <option value="Clarification">Clarification</option>
                                <option value="Conflict Resolution">Parent Conflict Resolution</option>
                                <option value="Study Abroad Planning">Study Abroad Planning</option>
                                <option value="Crisis Intervention">Crisis Intervention</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Parent Attended?</label>
                            <select class="form-select" id="logParent">
                                <option value="No">No</option>
                                <option value="Yes - Supportive">Yes - Supportive</option>
                                <option value="Yes - High Pressure">Yes - High Pressure</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Session Outcomes & Homework</label>
                        <textarea class="form-textarea" id="sessionNotesInput" rows="3" placeholder="Notes shared with student/parents..."></textarea>
                    </div>
                    
                    <div class="form-group" style="padding: 10px; background: rgba(244, 63, 94, 0.05); border-radius: 8px; border: 1px dashed var(--accent);">
                        <label class="form-label" style="color: var(--accent);">Internal Admin Escalation (Hidden from Student)</label>
                        <textarea class="form-textarea" id="adminNotesInput" rows="2" placeholder="Private alerts or concerns for Super Admin..." style="border-color: var(--accent);"></textarea>
                    </div>

                    <button class="btn btn-outline" id="saveNotesBtn" onclick="saveSessionNotes()" style="width: 100%;">Save to Case File</button>
                </div>
            </div>
        </div>

        <div id="tab-chat" class="tab-content">
            <div class="header-bar"><h1>Direct Student Chat</h1><p>Secure two-way communication channel.</p></div>
            <div class="grid-3-1">
                <div class="card" style="border-top: 4px solid var(--secondary); display:flex; flex-direction:column; height: 60vh; padding: 0;">
                    <div style="padding: 20px; border-bottom: 1px solid var(--border);">
                        <h3 style="border:none; padding:0; margin:0;">Chat: <span id="chatActiveStudent">Select a student</span></h3>
                    </div>
                    <div style="flex:1; padding: 20px; overflow-y:auto; background: #0f172a;" id="chatMessages">
                        <div style="text-align:center; color:var(--text-muted); margin-top:20px;">Select a student from the panel to view history.</div>
                    </div>
                    <div style="padding: 20px; border-top: 1px solid var(--border); display:flex; gap:10px;">
                        <input type="text" id="chatInput" class="form-input" placeholder="Type a message to the student..." style="margin:0;">
                        <button class="btn" onclick="sendChatMessage()">Send</button>
                    </div>
                </div>
                <div class="card" style="padding:0; overflow-y:auto; height: 60vh;">
                    <h3 style="padding: 20px; margin:0; border-bottom: 1px solid var(--border);">Active Roster</h3>
                    <div id="chatStudentList">
                        </div>
                </div>
            </div>
        </div>

        <div id="tab-interventions" class="tab-content">
            <div class="header-bar"><h1>Risk & Intervention Panel</h1><p>Auto-flagged students requiring clinical attention.</p></div>
            <div class="card" style="border-top: 4px solid var(--danger);">
                <h3>üö© High Priority Queue</h3>
                <table class="data-table">
                    <thead><tr><th>Student</th><th>Primary Risk Factor</th><th>Clarity Trend</th><th>Action Required</th></tr></thead>
                    <tbody id="interventionTableBody">
                        <tr><td colspan="4" style="text-align:center;">Scanning...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="tab-resources" class="tab-content">
            <div class="header-bar"><h1>Resource Library</h1><p>Upload and dispatch career materials for students.</p></div>
            
            <div class="grid-2col">
                <div class="card" style="border-top: 4px solid var(--primary);">
                    <h3>üì§ Upload New Resource</h3>
                    <div class="form-group">
                        <label class="form-label">Resource Title / Course Name</label>
                        <input type="text" class="form-input" placeholder="e.g. 2026 Design Portfolio Guide">
                    </div>
                    <div class="form-group">
                        <label class="form-label">File or PDF</label>
                        <input type="file" class="form-input" style="padding: 9px; background: rgba(0,0,0,0.2); border: 1px dashed var(--border);">
                    </div>
                    <button class="btn" style="width: 100%;">Upload to Library</button>
                </div>

                <div class="card">
                    <h3>Dispatch Resource to Student</h3>
                    <div class="form-group">
                        <label class="form-label">Select Resource</label>
                        <select class="form-select"><option>Guide: Understanding RIASEC</option><option>Worksheet: Stream Selection</option><option>Template: Building a Resume</option></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Select Target</label>
                        <select class="form-select"><option>Select Student...</option><option>All Grade 10 Students</option></select>
                    </div>
                    <button class="btn btn-outline" style="width:100%;">Send to Student Portal</button>
                </div>
            </div>
        </div>

        <div id="tab-profile" class="tab-content">
            <div class="header-bar"><h1>My Counsellor Profile</h1><p>Update your public details and availability.</p></div>
            <div class="card">
                <div class="grid-3-1">
                    <div>
                        <div class="grid-2col" style="gap:15px;">
                            <div class="form-group"><label class="form-label">Full Name</label><input type="text" id="profName" class="form-input"></div>
                            <div class="form-group"><label class="form-label">Registered Email</label><input type="text" id="profEmail" class="form-input" readonly style="background:rgba(0,0,0,0.2);"></div>
                        </div>
                        <div class="grid-2col" style="gap:15px;">
                            <div class="form-group"><label class="form-label">Designation / Credentials</label><input type="text" id="profTitle" class="form-input" placeholder="e.g. MSW, Certified Career Analyst"></div>
                            <div class="form-group"><label class="form-label">LinkedIn Profile URL</label><input type="url" id="profLinkedIn" class="form-input" placeholder="https://linkedin.com/in/..."></div>
                        </div>
                        <div class="form-group"><label class="form-label">Professional Bio</label><textarea id="profBio" class="form-textarea" rows="4" placeholder="Share your experience and clinical approach..."></textarea></div>
                    </div>
                    
                    <div style="text-align:center; border-left: 1px solid var(--border); padding-left: 20px;">
                        <h4 style="margin-top:0; color:var(--text-muted); font-size:0.85rem; text-transform:uppercase;">Profile Picture</h4>
                        <div class="avatar-wrapper" onclick="document.getElementById('photoUpload').click()" title="Click to change photo">
                            <img src="https://ui-avatars.com/api/?name=Expert&background=8b5cf6&color=fff" id="profAvatar" class="prof-avatar">
                        </div>
                        <input type="file" id="photoUpload" style="display: none;" accept="image/png, image/jpeg">
                        <p style="font-size:0.75rem; color:var(--text-muted);">Click image to upload. Recommended 500x500px.</p>
                        
                        <div class="form-group" style="margin-top:20px; text-align:left;">
                            <label class="form-label">Instagram URL</label>
                            <input type="url" id="profInsta" class="form-input" placeholder="Optional">
                        </div>
                    </div>
                </div>

                <button class="btn" style="margin-top:20px;" onclick="saveCounsellorProfile()">üíæ Save & Publish Profile</button>
            </div>
        </div>

    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, collection, getDocs, updateDoc, arrayUnion, query, where, orderBy, onSnapshot, serverTimestamp, addDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

    // ‚ö†Ô∏è USE YOUR REAL FIREBASE KEYS HERE
    const firebaseConfig = {
      apiKey: "AIzaSyBygHYMOSuKueZf9nE5LmSwCyCeZ2dNeD0",
      authDomain: "career-intelligence-system.firebaseapp.com",
      projectId: "career-intelligence-system",
      storageBucket: "career-intelligence-system.firebasestorage.app",
      messagingSenderId: "223785446772",
      appId: "1:223785446772:web:0f9ded4e89a978fc551021"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    let activeUserEmail = "";
    window.globalStudentData = {}; 
    let modalChartInstance = null; // Holds the mini line graph

    const options = { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' };
    document.getElementById('currentDateDisplay').innerText = new Date().toLocaleDateString('en-US', options);

    window.switchTab = function(tabId, btn) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        btn.classList.add('active');
        document.getElementById('headerTitle').innerText = btn.innerText.replace(/[^\w\s]/gi, '').trim();
    };

    window.toggleDropdown = function() { document.getElementById("profileDropdownBtn").classList.toggle("active"); }
    window.onclick = function(event) { if (!event.target.matches('.avatar-btn')) { document.getElementById("profileDropdownBtn").classList.remove("active"); } }
    window.logoutUser = function() { signOut(auth).then(() => { window.location.href = "index.html"; }); }

    // --- UPGRADED MODAL LOGIC (360 VIEW) ---
    window.openStudentModal = function(uid) {
        const student = window.globalStudentData[uid];
        if(!student) return;
        
        document.getElementById('modalStuName').innerText = student.name;
        document.getElementById('modalStuEmail').innerText = student.email;
        document.getElementById('modalStuGrade').innerText = "Grade " + (student.grade || "N/A");
        
        // 1. Academic & Traits
        if(student.academic) {
            document.getElementById('modalStuStream').innerText = student.academic.stream || "--";
            document.getElementById('modalStuMarks').innerText = student.academic.marks ? `${student.academic.marks}%` : "--";
            document.getElementById('modalStuStrong').innerText = student.academic.strongSub || "--";
        }

        document.getElementById('modalStuStatus').innerText = student.assessmentCompleted ? 'Assessment Done' : 'Pending Test';
        document.getElementById('modalStuStatus').className = student.assessmentCompleted ? 'badge badge-success' : 'badge badge-warning';

        document.getElementById('modalSessionCount').innerText = student.sessionsHad || "0";
        document.getElementById('modalParentInv').innerText = "Unknown"; // Will update based on notes

        if(student.psychIndex) {
            document.getElementById('modalStuClarity').innerText = student.psychIndex.careerClarity + " / 10";
            document.getElementById('modalStuTraits').innerText = student.riasecCode || "--";
            
            // Multi-Factor Risk Display
            let riskReason = "Stable";
            let rClass = "badge-success";
            
            if(student.psychIndex.riskCategory === "High") {
                rClass = "badge-danger";
                // Logic: Is it academic mismatch or parental pressure?
                if(student.academic && parseInt(student.academic.marks) < 55) {
                    riskReason = "Academic Mismatch Risk";
                } else if(student.psychIndex.parentPressure > 70) {
                    riskReason = "High Parent Expectation";
                } else {
                    riskReason = "Low Clarity / High Stress";
                }
            }
            document.getElementById('modalStuRisk').innerText = riskReason;
            document.getElementById('modalStuRisk').className = `badge ${rClass}`;

            // Career Alignment Fake Logic (Real logic would compare Stream + RIASEC)
            let alertMsg = "Strong Alignment.";
            if(student.academic && student.riasecCode) {
                if(student.academic.stream === "Commerce" && !student.riasecCode.includes('C') && !student.riasecCode.includes('E')) alertMsg = "‚ö†Ô∏è Mismatch Warning: Student in Commerce but lacks C/E traits.";
                if(student.academic.stream === "PCM" && !student.riasecCode.includes('I')) alertMsg = "‚ö†Ô∏è Mismatch Warning: PCM chosen but Investigative trait is low.";
            }
            document.getElementById('modalStuMatchAlert').innerText = alertMsg;

            // Readiness Indicator Logic
            document.querySelectorAll('.readiness-box').forEach(b => b.classList.remove('active'));
            let stage = 1; // Default
            if(student.assessmentCompleted) stage = 2;
            if(student.sessionsHad > 0) stage = 3;
            if(student.psychIndex.careerClarity >= 8) stage = 4;
            if(student.careerLocked) stage = 5;
            
            for(let i=1; i<=stage; i++) {
                document.getElementById(`r-stage-${i}`).classList.add('active');
            }

            // Clarity Graph Render
            renderClarityGraph(student.psychIndex.careerClarity);
        }

        // Render Last Note
        if(student.counsellorNotes && student.counsellorNotes.length > 0) {
            const last = student.counsellorNotes[student.counsellorNotes.length - 1];
            document.getElementById('modalLastNote').innerHTML = `
                <span style="color:var(--primary); font-size:0.8rem; font-weight:bold;">${new Date(last.date).toLocaleDateString()} - ${last.type || 'Session'}</span><br>
                ${last.note}
            `;
            if(last.parentAttended) document.getElementById('modalParentInv').innerText = last.parentAttended;
        } else {
            document.getElementById('modalLastNote').innerHTML = "No previous session notes found.";
        }

        document.getElementById('studentModal').style.display = 'flex';
    }

    window.closeStudentModal = function() { document.getElementById('studentModal').style.display = 'none'; }

    function renderClarityGraph(currentScore) {
        if (typeof Chart === 'undefined') return;
        const ctx = document.getElementById('modalClarityChart');
        if(!ctx) return;
        if(modalChartInstance) modalChartInstance.destroy();
        
        // Mocking historical data based on current score
        let s1 = Math.max(1, currentScore - 4);
        let s2 = Math.max(3, currentScore - 2);
        
        modalChartInstance = new Chart(ctx.getContext('2d'), {
            type: 'line',
            data: { 
                labels: ['Registration', 'Assessment', 'Current'], 
                datasets: [{ 
                    label: 'Clarity Score',
                    data: [s1, s2, currentScore], 
                    borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', borderWidth: 3, pointRadius: 5, fill: true, tension: 0.3 
                }] 
            },
            options: { 
                responsive: true, maintainAspectRatio: false, 
                plugins: { legend: { display: false } }, 
                scales: { 
                    x: { ticks: { color: '#94a3b8' }, grid: { display: false } }, 
                    y: { min: 0, max: 10, ticks: { color: '#64748b' }, grid: { color: 'rgba(255,255,255,0.05)' } } 
                } 
            }
        });
    }

    // --- FIREBASE SECURITY & INITIALIZATION ---
    onAuthStateChanged(auth, async (user) => {
        if (!user) { window.location.href = "index.html"; return; }
        activeUserEmail = user.email.toLowerCase();

        try {
            const permsRef = doc(db, "permissions", activeUserEmail);
            const permsSnap = await getDoc(permsRef);

            if (permsSnap.exists() && (permsSnap.data().role === "counsellor" || permsSnap.data().role === "super_admin")) {
                document.getElementById('dropEmail').innerText = user.email;
                document.getElementById('profEmail').value = user.email;
                const name = user.displayName || user.email.split('@')[0];
                document.getElementById('dropName').innerText = name;
                document.getElementById('profName').value = name;
                
                loadCounsellorProfile(activeUserEmail);
                loadAssignedStudents();
                listenToBookings(activeUserEmail); 

            } else {
                alert("Unauthorized: You do not have Counsellor clearance.");
                window.location.href = "student_portal.html";
            }
        } catch (error) { console.error("Security check failed:", error); }
    });

    // --- PROFILE IMAGE UPLOAD & SAVE ---
    let profileImageBase64 = "";
    document.getElementById('photoUpload').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader(); reader.readAsDataURL(file);
        reader.onload = function(event) {
            const img = new Image(); img.src = event.target.result;
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const scaleSize = 250 / img.width; canvas.width = 250; canvas.height = img.height * scaleSize;
                const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                profileImageBase64 = canvas.toDataURL("image/jpeg", 0.8);
                document.getElementById('profAvatar').src = profileImageBase64;
                document.getElementById('topAvatarImg').src = profileImageBase64;
            }
        };
    });

    window.saveCounsellorProfile = async function() {
        if(!activeUserEmail) return;
        try {
            await setDoc(doc(db, "counsellor_profiles", activeUserEmail), {
                name: document.getElementById('profName').value,
                title: document.getElementById('profTitle').value,
                bio: document.getElementById('profBio').value,
                linkedin: document.getElementById('profLinkedIn').value,
                instagram: document.getElementById('profInsta').value,
                photo: profileImageBase64,
                lastUpdated: new Date().toISOString()
            }, { merge: true });
            alert("Profile Saved Successfully!");
        } catch(e) { console.error(e); alert("Failed to save profile."); }
    }

    async function loadCounsellorProfile(email) {
        try {
            const snap = await getDoc(doc(db, "counsellor_profiles", email));
            if(snap.exists()) {
                const data = snap.data();
                if(data.photo) { document.getElementById('profAvatar').src = data.photo; document.getElementById('topAvatarImg').src = data.photo; profileImageBase64 = data.photo; }
                if(data.name) document.getElementById('profName').value = data.name;
                if(data.title) document.getElementById('profTitle').value = data.title;
                if(data.bio) document.getElementById('profBio').value = data.bio;
                if(data.linkedin) document.getElementById('profLinkedIn').value = data.linkedin;
                if(data.instagram) document.getElementById('profInsta').value = data.instagram;
            }
        } catch(e) { console.error(e); }
    }


    // --- LOAD LIVE STUDENTS (UPGRADED WITH SEARCH & MULTI-RISK) ---
    window.loadAssignedStudents = async function() {
        const tbody = document.getElementById('studentTableBody');
        const sessionSelect = document.getElementById('sessionStudentSelect');
        const chatList = document.getElementById('chatStudentList');
        const interventionBody = document.getElementById('interventionTableBody');
        
        const filterVal = document.getElementById('clinicalFilter') ? document.getElementById('clinicalFilter').value : "ALL";
        const searchVal = document.getElementById('studentSearchInput') ? document.getElementById('studentSearchInput').value.toLowerCase() : "";

        try {
            const snap = await getDocs(collection(db, "students"));
            let studentCount = 0; let riskCount = 0;
            let intHtml = "";
            
            tbody.innerHTML = "";
            sessionSelect.innerHTML = '<option value="">-- Select Student --</option>';
            chatList.innerHTML = "";
            window.globalStudentData = {}; 

            if (snap.empty) {
                tbody.innerHTML = "<tr><td colspan='6' style='text-align:center;'>No students registered yet.</td></tr>";
                return;
            }

            snap.forEach(docSnap => {
                const data = docSnap.data();
                window.globalStudentData[docSnap.id] = data; 

                // Search Filter
                if (searchVal && !data.name.toLowerCase().includes(searchVal)) return;

                // Risk & Clinical Logic
                let riskBadge = '<span class="badge badge-success">Stable</span>';
                let primaryRiskString = "None";
                let isHighRisk = false;

                if(data.psychIndex && data.psychIndex.riskCategory === "High") {
                    isHighRisk = true;
                    riskBadge = '<span class="badge badge-danger">High Risk</span>';
                    
                    if(data.academic && parseInt(data.academic.marks) < 55) primaryRiskString = "Academic Mismatch";
                    else if(data.psychIndex.parentPressure > 70) primaryRiskString = "Parent Expectation";
                    else primaryRiskString = "Low Clarity / High Stress";

                    riskCount++;
                    intHtml += `<tr><td><strong>${data.name}</strong></td><td>${primaryRiskString}</td><td>${data.psychIndex.careerClarity || 0}/10 üìâ</td><td><button class="btn btn-outline" style="padding:4px 8px; font-size:0.8rem;" onclick="switchTab('tab-chat', document.querySelectorAll('.nav-btn')[3]); openChat('${docSnap.id}', '${data.name}')">Message User</button></td></tr>`;
                }
                else if(!data.assessmentCompleted) riskBadge = '<span class="badge badge-warning">Needs Assmnt</span>';

                // Tab Filter Logic
                if (filterVal === "RISK" && !isHighRisk) return;
                if (filterVal === "LOCKED" && !data.careerLocked) return;
                if (filterVal === "PENDING" && data.assessmentCompleted) return;

                studentCount++;

                tbody.innerHTML += `<tr>
                    <td><strong style="color:white;">${data.name}</strong></td>
                    <td style="color:var(--text-muted);">${data.email}</td>
                    <td>Grade ${data.grade || 'N/A'}</td>
                    <td>${data.assessmentCompleted ? '<span style="color:var(--success);">Complete</span>' : '<span style="color:var(--text-muted);">Pending</span>'}</td>
                    <td>${primaryRiskString !== "None" ? `<span style="color:var(--danger); font-weight:bold; font-size:0.85rem;">${primaryRiskString}</span>` : riskBadge}</td>
                    <td><button class="btn btn-outline" style="padding:6px 12px; font-size:0.8rem;" onclick="openStudentModal('${docSnap.id}')">View File</button></td>
                </tr>`;

                sessionSelect.innerHTML += `<option value="${docSnap.id}">${data.name} (${data.grade || 'N/A'})</option>`;

                chatList.innerHTML += `
                    <div class="list-item" style="padding: 15px 20px; cursor:pointer;" onclick="openChat('${docSnap.id}', '${data.name}')" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">
                        <div>
                            <strong style="color:white; display:block;">${data.name}</strong>
                            <span style="font-size:0.8rem; color:var(--text-muted);">Grade ${data.grade || 'N/A'}</span>
                        </div>
                        <span style="color:var(--primary);">üí¨</span>
                    </div>`;
            });

            if(studentCount === 0) tbody.innerHTML = "<tr><td colspan='6' style='text-align:center;'>No students found matching filters.</td></tr>";

            document.getElementById('kpiStudents').innerText = studentCount;
            document.getElementById('kpiRisk').innerText = riskCount;
            if(intHtml) interventionBody.innerHTML = intHtml;
            else interventionBody.innerHTML = "<tr><td colspan='4' style='text-align:center;'>No high-risk students currently detected.</td></tr>";

            // SaaS Intervention Suggestion Engine
            if(riskCount > 0) {
                document.getElementById('alertBox').innerHTML = `<p><strong style="color:var(--danger);">‚ö†Ô∏è Urgent:</strong> ${riskCount} students flagged with High Risk clinical metrics. Review Intervention Panel.</p>`;
                document.getElementById('interventionSuggestionPanel').style.display = 'block';
                document.getElementById('interventionText').innerText = "System detects elevated Parent Expectation stress across multiple files. Recommend bulk dispatching 'Parent Alignment Worksheet' from Resource Library.";
            } else {
                document.getElementById('alertBox').innerHTML = `<p style="color:var(--success);">System clear. No urgent clinical flags detected.</p>`;
                document.getElementById('interventionSuggestionPanel').style.display = 'none';
            }

        } catch(e) { 
            console.error("Error loading students:", e); 
            tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; color:red;'>Failed to load database.</td></tr>";
        }
    }

    // --- REAL-TIME BOOKING LISTENER ---
    window.listenToBookings = function(counsellorEmail) {
        const q = query(collection(db, "bookings"), where("counsellorId", "==", counsellorEmail), orderBy("timestamp", "desc"));
        onSnapshot(q, (snapshot) => {
            const container = document.getElementById('bookingRequestsContainer');
            let pendingCount = 0; let confirmedCount = 0;
            
            if (snapshot.empty) {
                container.innerHTML = '<div style="text-align:center; padding: 20px; color:var(--text-muted);">No appointments booked yet.</div>';
                document.getElementById('kpiPending').innerText = 0;
                document.getElementById('kpiConfirmed').innerText = 0;
                return;
            }

            let html = '';
            snapshot.forEach(doc => {
                const b = doc.data();
                if(b.status === 'Pending') pendingCount++;
                if(b.status === 'Confirmed') confirmedCount++;

                let statusColor = b.status === 'Pending' ? 'var(--warning)' : (b.status === 'Confirmed' ? 'var(--success)' : 'var(--danger)');
                
                html += `
                    <div class="case-item">
                        <div class="case-status" style="background:${statusColor};"></div>
                        <div class="case-info">
                            <span class="case-time">${b.date} at ${b.time} (${b.medium})</span>
                            <div style="font-weight:bold; color:white; font-size:1.1rem; margin-top:2px;">${b.studentName} <span class="badge" style="margin-left:10px; background:rgba(255,255,255,0.1); color:${statusColor}; border:1px solid ${statusColor};">${b.status}</span></div>
                            <div style="font-size:0.85rem; color:var(--text-muted); margin-top:4px;">üìû <a href="tel:${b.phone}" style="color:var(--secondary); text-decoration:none;">${b.phone}</a> &nbsp;|&nbsp; ‚úâÔ∏è <a href="mailto:${b.studentEmail}" style="color:var(--secondary); text-decoration:none;">${b.studentEmail}</a></div>
                        </div>
                        <div style="display:flex; flex-direction:column; gap:8px;">
                            ${b.status === 'Pending' ? `
                                <button class="btn" style="padding: 6px 12px; font-size: 0.8rem; background:var(--success);" onclick="updateBookingStatus('${doc.id}', 'Confirmed')">Accept</button>
                                <button class="btn btn-outline" style="padding: 6px 12px; font-size: 0.8rem; border-color:var(--danger); color:var(--danger);" onclick="updateBookingStatus('${doc.id}', 'Cancelled')">Decline</button>
                            ` : ''}
                            ${b.status === 'Confirmed' ? `
                                <button class="btn" style="padding: 6px 12px; font-size: 0.8rem;" onclick="switchTab('tab-chat', document.querySelectorAll('.nav-btn')[3]); openChat('${b.studentId}', '${b.studentName}')">Message Student</button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
            document.getElementById('kpiPending').innerText = pendingCount;
            document.getElementById('kpiConfirmed').innerText = confirmedCount;
        });
    }

    window.updateBookingStatus = async function(id, status) {
        try { await updateDoc(doc(db, "bookings", id), { status: status }); } catch (e) { console.error(e); alert("Failed to update status."); }
    }

    // --- STRUCTURED SESSION NOTES LOGIC ---
    window.saveSessionNotes = async function() {
        const studentUid = document.getElementById('sessionStudentSelect').value; 
        const type = document.getElementById('logType').value;
        const parent = document.getElementById('logParent').value;
        const notes = document.getElementById('sessionNotesInput').value.trim();
        const adminNotes = document.getElementById('adminNotesInput').value.trim(); 
        const btn = document.getElementById('saveNotesBtn');

        if(!studentUid || !notes) return alert("Please select a student and write a session summary.");

        btn.innerText = "Saving... ‚è≥"; btn.disabled = true;

        try {
            await updateDoc(doc(db, "students", studentUid), {
                counsellorNotes: arrayUnion({
                    date: new Date().toISOString(), 
                    type: type,
                    parentAttended: parent,
                    note: notes, 
                    adminEscalation: adminNotes, 
                    counsellorEmail: activeUserEmail
                })
            });
            alert("Structured clinical notes saved to student dossier.");
            document.getElementById('sessionNotesInput').value = "";
            document.getElementById('adminNotesInput').value = "";
            loadAssignedStudents(); // Refresh modal data secretly
        } catch (e) {
            console.error(e); alert("Failed to save notes. Ensure you have the correct permissions.");
        } finally {
            btn.innerText = "Save to Case File"; btn.disabled = false;
        }
    }

    // --- REALTIME CHAT SYSTEM ---
    let currentChatStudentId = null;
    let unsubscribeChat = null;
    
    window.openChat = function(studentId, studentName) {
        currentChatStudentId = studentId;
        document.getElementById('chatActiveStudent').innerText = studentName;
        
        const chatBox = document.getElementById('chatMessages');
        chatBox.innerHTML = '<div style="text-align:center; color:var(--text-muted); margin-top:20px;">Loading encrypted chat history...</div>';

        if(unsubscribeChat) unsubscribeChat();

        const chatId = `${studentId}_${activeUserEmail}`;
        const q = query(collection(db, "chats", chatId, "messages"), orderBy("timestamp", "asc"));
        
        unsubscribeChat = onSnapshot(q, (snapshot) => {
            let html = `<div style="text-align:center; color:var(--text-muted); margin-bottom: 20px; font-size:0.85rem;">üîí Secure connection established with ${studentName}.</div>`;
            
            if(snapshot.empty) {
                html += `<div style="text-align:center; color:var(--text-muted);">No messages yet. Send a greeting to start the conversation!</div>`;
            } else {
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const isMe = msg.senderId === activeUserEmail;
                    const timeString = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'Sending...';
                    
                    if(isMe) {
                        html += `
                        <div class="chat-message msg-me">
                            ${msg.text}
                            <div class="chat-time" style="color:rgba(255,255,255,0.7);">${timeString}</div>
                        </div>`;
                    } else {
                        html += `
                        <div class="chat-message msg-them">
                            ${msg.text}
                            <div class="chat-time">${timeString}</div>
                        </div>`;
                    }
                });
            }
            chatBox.innerHTML = html;
            chatBox.scrollTop = chatBox.scrollHeight;
        });
    }

    window.sendChatMessage = async function() {
        if(!currentChatStudentId) return alert("Select a student to chat with first.");
        const input = document.getElementById('chatInput');
        const text = input.value.trim();
        if(!text) return;

        input.value = "";
        
        try {
            const chatId = `${currentChatStudentId}_${activeUserEmail}`;
            await addDoc(collection(db, "chats", chatId, "messages"), {
                text: text,
                senderId: activeUserEmail,
                senderType: 'counsellor',
                timestamp: serverTimestamp()
            });
        } catch(e) {
            console.error(e);
            alert("Error sending message.");
        }
    }

</script>
</body>
</html>
