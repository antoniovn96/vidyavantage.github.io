<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Counsellor Dashboard | Case Management</title>
    <style>
      :root {
        --bg: #0f172a; --sidebar: #1e1b4b; --card-bg: #1e293b; 
        --primary: #8b5cf6; --secondary: #06b6d4; --accent: #f43f5e;
        --text-main: #f8fafc; --text-muted: #94a3b8; --border: #334155;
        --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
      }
      body { background-color: var(--bg); font-family: 'Nunito', sans-serif; color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden; }
      
      /* --- SIDEBAR --- */
      .sidebar { width: 280px; background: var(--sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding-top: 20px; overflow-y: auto;}
      .brand { padding: 0 20px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
      .brand h2 { margin: 0; font-size: 1.5rem; background: -webkit-linear-gradient(45deg, var(--secondary), var(--primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 900; }
      
      .nav-btn { background: transparent; color: var(--text-muted); border: none; text-align: left; padding: 15px 25px; font-size: 0.95rem; font-weight: bold; cursor: pointer; transition: 0.2s; border-left: 4px solid transparent; width: 100%; display: flex; align-items: center; gap: 10px; }
      .nav-btn:hover { background: rgba(255,255,255,0.05); color: white; }
      .nav-btn.active { background: rgba(139, 92, 246, 0.1); color: var(--primary); border-left-color: var(--primary); }

      /* --- MAIN LAYOUT & TOP HEADER --- */
      .main-wrapper { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
      
      .top-header { background: var(--card-bg); height: 70px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; padding: 0 40px; }
      .header-actions { display: flex; align-items: center; gap: 20px; }
      .site-link { color: var(--secondary); text-decoration: none; font-weight: bold; padding: 8px 15px; border-radius: 8px; background: rgba(6, 182, 212, 0.1); transition: 0.2s;}
      .site-link:hover { background: rgba(6, 182, 212, 0.2); }
      
      /* User Profile Dropdown */
      .profile-menu { position: relative; display: inline-block; }
      .avatar-btn { width: 45px; height: 45px; border-radius: 50%; border: 2px solid var(--primary); cursor: pointer; object-fit: cover; background: #000;}
      .dropdown-content { display: none; position: absolute; right: 0; background-color: var(--card-bg); min-width: 200px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.5); z-index: 100; border-radius: 12px; border: 1px solid var(--border); overflow: hidden; margin-top: 10px;}
      .dropdown-content a { color: var(--text-main); padding: 12px 16px; text-decoration: none; display: block; font-size: 0.9rem; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.05);}
      .dropdown-content a:hover { background-color: rgba(255,255,255,0.05); color: var(--primary); }
      .profile-menu.active .dropdown-content { display: block; }

      /* --- CONTENT AREA --- */
      .main-content { flex: 1; padding: 30px 40px; overflow-y: auto; position: relative;}
      .tab-content { display: none; animation: fadeIn 0.3s ease; }
      .tab-content.active { display: block; }
      
      .header-bar { margin-bottom: 30px; display: flex; justify-content: space-between; align-items: flex-end;}
      .header-bar h1 { margin: 0 0 5px 0; font-size: 1.8rem; }
      .header-bar p { margin: 0; color: var(--text-muted); }

      /* UI COMPONENTS */
      .card { background: var(--card-bg); padding: 25px; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
      .card h3 { margin-top: 0; color: white; border-bottom: 1px solid var(--border); padding-bottom: 10px; font-size: 1.2rem; display: flex; justify-content: space-between; align-items: center; }
      
      .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
      .kpi-box { background: linear-gradient(135deg, rgba(30,41,59,1) 0%, rgba(15,23,42,1) 100%); padding: 20px; border-radius: 12px; border: 1px solid var(--border); }
      .kpi-box h4 { margin:0 0 10px 0; color:var(--text-muted); font-size:0.85rem; text-transform:uppercase;}
      .kpi-box .val { font-size:2rem; font-weight:900; color:white; }
      
      .grid-3-1 { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; }
      .grid-2col { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }

      .form-group { margin-bottom: 15px; }
      .form-label { display: block; font-weight: 700; margin-bottom: 6px; color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase;}
      .form-input, .form-select, .form-textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.95rem; color: white; background: #0f172a; box-sizing: border-box; font-family: inherit;}
      .form-input:focus, .form-select:focus { border-color: var(--primary); outline: none; }
      .btn { background: linear-gradient(45deg, var(--primary), #a855f7); color: white; border: none; padding: 12px 25px; font-size: 1rem; font-weight: bold; border-radius: 8px; cursor: pointer; transition: 0.2s; }
      .btn:hover { opacity: 0.9; transform: translateY(-2px); }
      .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
      .btn-outline:hover { background: rgba(139, 92, 246, 0.1); }

      .data-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
      .data-table th, .data-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); }
      .data-table th { color: var(--text-muted); text-transform: uppercase; font-size: 0.8rem; }
      .data-table tr:hover { background: rgba(255,255,255,0.02); }

      .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }
      .badge-success { background: rgba(16, 185, 129, 0.2); color: var(--success); border: 1px solid var(--success);}
      .badge-warning { background: rgba(245, 158, 11, 0.2); color: var(--warning); border: 1px solid var(--warning);}
      .badge-danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); border: 1px solid var(--danger);}

      /* CASE LIST STYLING */
      .case-item { display: flex; align-items: center; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 12px; margin-bottom: 12px; border: 1px solid transparent; transition: 0.2s; }
      .case-item:hover { border-color: var(--primary); transform: translateX(5px); }
      .case-status { width: 12px; height: 12px; border-radius: 50%; margin-right: 15px; }
      .case-info { flex: 1; }
      .case-time { font-size: 0.8rem; color: var(--secondary); font-weight: bold; }

      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="brand">
        <h2>Career Intel</h2>
        <span style="color:var(--text-muted); padding-left:20px; font-size:0.75rem; letter-spacing: 1px;">CLINICAL PANEL</span>
    </div>
    <button class="nav-btn active" onclick="switchTab('tab-overview', this)">üè† Overview</button>
    <button class="nav-btn" onclick="switchTab('tab-queue', this)">üéì Student Queue</button>
    <button class="nav-btn" onclick="switchTab('tab-sessions', this)">üìÖ Session Manager</button>
    <button class="nav-btn" onclick="switchTab('tab-interventions', this)">üö® Interventions</button>
    <button class="nav-btn" onclick="switchTab('tab-resources', this)">üìö Resources</button>
    <div style="border-top: 1px solid var(--border); margin: 15px 20px;"></div>
    <button class="nav-btn" onclick="switchTab('tab-profile', this)">‚öôÔ∏è My Settings</button>
</div>

<div class="main-wrapper">
    <div class="top-header">
        <h2 style="margin:0; font-size:1.1rem; color:var(--text-muted);" id="headerTitle">Counselor Dashboard</h2>
        
        <div class="header-actions">
            <a href="index.html" class="site-link">üåê Live Website</a>
            
            <div class="profile-menu" id="profileDropdownBtn">
                <img src="https://via.placeholder.com/150" class="avatar-btn" id="topAvatarImg" onclick="toggleDropdown()">
                <div class="dropdown-content">
                    <div style="padding: 15px; border-bottom: 1px solid var(--border); background:rgba(0,0,0,0.2);">
                        <strong id="dropName" style="color:white; display:block;">Counselor Name</strong>
                        <span id="dropEmail" style="font-size:0.8rem; color:var(--text-muted);">email@gmail.com</span>
                    </div>
                    <a href="#" onclick="switchTab('tab-profile', document.querySelectorAll('.nav-btn')[5]); toggleDropdown();">‚öôÔ∏è My Settings</a>
                    <a href="#" style="color:var(--danger);" onclick="logoutUser()">üö™ Secure Logout</a>
                </div>
            </div>
        </div>
    </div>

    <div class="main-content">
        
        <div id="tab-overview" class="tab-content active">
            <div class="header-bar">
                <div>
                    <h1>Counselor Command Center</h1>
                    <p id="currentDateDisplay">Tuesday, Feb 24, 2026</p>
                </div>
            </div>

            <div class="kpi-grid">
                <div class="kpi-box" style="border-top: 3px solid var(--primary);"><h4>Assigned Students</h4><div class="val" id="kpiStudents">0</div></div>
                <div class="kpi-box" style="border-top: 3px solid var(--secondary);"><h4>Sessions Today</h4><div class="val">3</div></div>
                <div class="kpi-box" style="border-top: 3px solid var(--danger);"><h4>High Risk Flags</h4><div class="val">2</div></div>
                <div class="kpi-box" style="border-top: 3px solid var(--warning);"><h4>Pending Reports</h4><div class="val">5</div></div>
            </div>

            <div class="grid-3-1">
                <div>
                    <div class="card">
                        <h3>Today's Appointment Queue</h3>
                        
                        <div class="case-item">
                            <div class="case-status" style="background:var(--danger);"></div>
                            <div class="case-info">
                                <span class="case-time">10:30 AM (Online)</span>
                                <div style="font-weight:bold;">Aryan Sharma <span class="badge badge-danger" style="margin-left: 10px;">High Parent Pressure</span></div>
                                <div style="font-size:0.8rem; color:var(--text-muted);">The Knowledge Habitat ‚Ä¢ Grade 10</div>
                            </div>
                            <button class="btn btn-outline" style="padding: 6px 12px; font-size: 0.8rem;">Start Session</button>
                        </div>

                        <div class="case-item">
                            <div class="case-status" style="background:var(--warning);"></div>
                            <div class="case-info">
                                <span class="case-time">11:45 AM (Offline)</span>
                                <div style="font-weight:bold;">Priya Kaur <span class="badge badge-warning" style="margin-left: 10px;">Stream Ambiguity</span></div>
                                <div style="font-size:0.8rem; color:var(--text-muted);">Sri Sharada Public School ‚Ä¢ Grade 12</div>
                            </div>
                            <button class="btn btn-outline" style="padding: 6px 12px; font-size: 0.8rem;">Start Session</button>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="card" style="border-top: 4px solid var(--danger);">
                        <h3>System Alerts</h3>
                        <div style="font-size:0.9rem; color:var(--text-muted); line-height: 1.6;">
                            <p><strong style="color:var(--danger);">‚ö†Ô∏è Urgent:</strong> 2 students completed assessments indicating severe career anxiety.</p>
                            <hr style="border:0; border-top:1px dashed var(--border); margin:10px 0;">
                            <p><strong style="color:var(--warning);">Action Required:</strong> Parent meeting requested for Rahul D.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-queue" class="tab-content">
            <div class="header-bar">
                <div>
                    <h1>Student Queue</h1>
                    <p>Live database of all students assigned to your roster.</p>
                </div>
                <input type="text" class="form-input" placeholder="Search student name..." style="width: 250px;">
            </div>

            <div class="card">
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Email</th>
                                <th>Grade</th>
                                <th>Assessment</th>
                                <th>Risk Indicator</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="studentTableBody">
                            <tr><td colspan="6" style="text-align:center;">Loading assigned students...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-sessions" class="tab-content">
            <div class="header-bar"><h1>Session Management</h1><p>Control your calendar and log session notes.</p></div>
            <div class="grid-2col">
                <div class="card">
                    <h3>Upcoming Calendar</h3>
                    <p style="color:var(--text-muted); text-align:center; padding:40px;">Calendar integration coming soon. Use Overview tab for today's queue.</p>
                </div>
                <div class="card" style="border-top: 4px solid var(--primary);">
                    <h3>Log Session Notes</h3>
                    <div class="form-group"><label class="form-label">Select Student</label><select class="form-select"><option>Aryan Sharma</option><option>Priya Kaur</option></select></div>
                    <div class="form-group"><label class="form-label">Session Summary & Observations</label><textarea class="form-textarea" rows="4" placeholder="Confidential clinical notes..."></textarea></div>
                    <div class="form-group"><label class="form-label">Next Action Plan</label><input type="text" class="form-input" placeholder="e.g. Needs to research Design colleges."></div>
                    <button class="btn" style="width: 100%;">Save to Case File</button>
                </div>
            </div>
        </div>

        <div id="tab-interventions" class="tab-content">
            <div class="header-bar"><h1>Risk & Intervention Panel</h1><p>Auto-flagged students requiring clinical attention.</p></div>
            <div class="card" style="border-top: 4px solid var(--danger);">
                <h3>üö© High Priority Queue</h3>
                <table class="data-table">
                    <thead><tr><th>Student</th><th>Primary Risk Factor</th><th>Clarity Score</th><th>Action Required</th></tr></thead>
                    <tbody>
                        <tr><td>Arjun Mehta</td><td>High Parent Pressure</td><td>3/10</td><td><button class="btn btn-outline" style="padding:4px 8px; font-size:0.8rem;">Schedule Parent Call</button></td></tr>
                        <tr><td>Sneha Patil</td><td>High Stress / Burnout</td><td>4/10</td><td><button class="btn btn-outline" style="padding:4px 8px; font-size:0.8rem;">Immediate Follow-up</button></td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="tab-resources" class="tab-content">
            <div class="header-bar"><h1>Resource Library</h1><p>Shareable guides and career materials for students.</p></div>
            <div class="card">
                <h3>Send Resource to Student</h3>
                <div style="display:flex; gap:15px; margin-bottom: 20px;">
                    <select class="form-select" style="flex:1;"><option>Guide: Understanding RIASEC</option><option>Worksheet: Stream Selection</option><option>Template: Building a Resume</option></select>
                    <select class="form-select" style="flex:1;"><option>Select Student...</option><option>All Grade 10 Students</option></select>
                </div>
                <button class="btn">Dispatch to Portal</button>
            </div>
        </div>

        <div id="tab-profile" class="tab-content">
            <div class="header-bar"><h1>My Counsellor Profile</h1><p>Update your public details and availability.</p></div>
            <div class="card">
                <div class="grid-2col">
                    <div class="form-group"><label class="form-label">Full Name</label><input type="text" id="profName" class="form-input" readonly style="background:rgba(0,0,0,0.2);"></div>
                    <div class="form-group"><label class="form-label">Registered Email</label><input type="text" id="profEmail" class="form-input" readonly style="background:rgba(0,0,0,0.2);"></div>
                </div>
                <div class="grid-2col">
                    <div class="form-group"><label class="form-label">Specialization / Designation</label><input type="text" class="form-input" placeholder="e.g. Clinical Career Psychologist"></div>
                    <div class="form-group"><label class="form-label">Session Booking Link (Calendly/Meet)</label><input type="url" class="form-input" placeholder="https://calendly.com/..."></div>
                </div>
                <div class="form-group"><label class="form-label">Professional Bio</label><textarea class="form-textarea" rows="3"></textarea></div>
                <button class="btn">Save Profile Updates</button>
            </div>
        </div>

    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

    // ‚ö†Ô∏è REPLACE WITH YOUR ACTUAL CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyBygHYMOSuKueZf9nE5LmSwCyCeZ2dNeD0",
      authDomain: "career-intelligence-system.firebaseapp.com",
      projectId: "career-intelligence-system",
      storageBucket: "career-intelligence-system.firebasestorage.app",
      messagingSenderId: "223785446772",
      appId: "1:223785446772:web:0f9ded4e89a978fc551021",
      measurementId: "G-HGKJJN9KDF"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Set Date
    const options = { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' };
    document.getElementById('currentDateDisplay').innerText = new Date().toLocaleDateString('en-US', options);

    // --- TAB NAVIGATION LOGIC ---
    window.switchTab = function(tabId, btn) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        btn.classList.add('active');
        document.getElementById('headerTitle').innerText = btn.innerText.replace(/[^\w\s]/gi, '').trim();
    };

    window.toggleDropdown = function() { document.getElementById("profileDropdownBtn").classList.toggle("active"); }
    window.onclick = function(event) { if (!event.target.matches('.avatar-btn')) { document.getElementById("profileDropdownBtn").classList.remove("active"); } }
    window.logoutUser = function() { signOut(auth).then(() => { window.location.href = "index.html"; }); }

    // --- FIREBASE SECURITY & DATA LOADING ---
    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            window.location.href = "index.html"; 
            return;
        }

        const email = user.email.toLowerCase();

        try {
            // Verify Counsellor Status
            const permsRef = doc(db, "permissions", email);
            const permsSnap = await getDoc(permsRef);

            if (permsSnap.exists() && (permsSnap.data().role === "counsellor" || permsSnap.data().role === "school_admin")) {
                
                // Populate Profile
                document.getElementById('dropEmail').innerText = user.email;
                document.getElementById('profEmail').value = user.email;
                const name = user.displayName || user.email.split('@')[0];
                document.getElementById('dropName').innerText = name;
                document.getElementById('profName').value = name;
                
                // Load Students Database
                loadAssignedStudents();

            } else {
                alert("Unauthorized: You do not have Counsellor clearance.");
                window.location.href = "student_portal.html";
            }
        } catch (error) {
            console.error("Security check failed:", error);
        }
    });

    // --- LOAD LIVE STUDENTS INTO QUEUE ---
    async function loadAssignedStudents() {
        const tbody = document.getElementById('studentTableBody');
        try {
            const snap = await getDocs(collection(db, "students"));
            let studentCount = 0;
            tbody.innerHTML = "";

            if (snap.empty) {
                tbody.innerHTML = "<tr><td colspan='6' style='text-align:center;'>No students registered yet.</td></tr>";
                return;
            }

            snap.forEach(docSnap => {
                const data = docSnap.data();
                studentCount++;

                // Mock Risk Logic based on Assessment Status
                let riskBadge = '<span class="badge badge-success">Stable</span>';
                if(!data.assessmentCompleted) riskBadge = '<span class="badge badge-warning">Needs Assmnt</span>';
                
                tbody.innerHTML += `<tr>
                    <td><strong style="color:white;">${data.name}</strong></td>
                    <td style="color:var(--text-muted);">${data.email}</td>
                    <td>Grade ${data.grade || 'N/A'}</td>
                    <td>${data.assessmentCompleted ? '<span style="color:var(--success);">Complete</span>' : '<span style="color:var(--text-muted);">Pending</span>'}</td>
                    <td>${riskBadge}</td>
                    <td><button class="btn btn-outline" style="padding:4px 8px; font-size:0.8rem;">View File</button></td>
                </tr>`;
            });

            document.getElementById('kpiStudents').innerText = studentCount;

        } catch(e) { 
            console.error("Error loading students:", e); 
            tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; color:red;'>Failed to load database.</td></tr>";
        }
    }
</script>
</body>
</html>
