<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Student Registration | Career Intel</title>
    <style>
      :root {
        --bg: #0f172a; --card-bg: #1e293b; --primary: #6366f1; 
        --text-main: #f8fafc; --text-muted: #94a3b8; --border: #334155;
      }
      body { background: var(--bg); font-family: 'Nunito', sans-serif; color: var(--text-main); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
      .reg-card { background: var(--card-bg); padding: 40px; border-radius: 20px; border: 1px solid var(--border); width: 100%; max-width: 450px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
      h1 { margin-top: 0; font-size: 1.8rem; text-align: center; background: linear-gradient(to right, #818cf8, #c084fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
      .form-group { margin-bottom: 20px; }
      label { display: block; margin-bottom: 8px; font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; font-weight: bold; }
      .form-input, .form-select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: #0f172a; color: white; box-sizing: border-box; }
      .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; background: var(--primary); color: white; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.3s; }
      .btn:hover { opacity: 0.9; transform: translateY(-2px); }
      .loader { text-align: center; font-size: 0.9rem; color: var(--secondary); margin-top: 15px; display: none; }
    </style>
</head>
<body>

<div class="reg-card">
    <h1>Create Student Account</h1>
    <p style="text-align: center; color: var(--text-muted); font-size: 0.9rem; margin-bottom: 30px;">Join your institution's career guidance program.</p>

    <div class="form-group">
        <label>Full Name</label>
        <input type="text" id="stuName" class="form-input" placeholder="Enter your full name">
    </div>

    <div class="form-group">
        <label>Select Your Institution</label>
        <select id="stuSchool" class="form-select">
            <option value="">-- Choose School --</option>
            </select>
    </div>

    <div class="form-group">
        <label>School Access Code</label>
        <input type="text" id="stuCode" class="form-input" placeholder="Provided by your counselor">
    </div>

    <div class="form-group">
        <label>Current Grade</label>
        <select id="stuGrade" class="form-select">
            <option>Grade 8</option><option>Grade 9</option><option selected>Grade 10</option><option>Grade 11</option><option>Grade 12</option>
        </select>
    </div>

    <button class="btn" onclick="registerStudent()">Start My Journey</button>
    <div id="status" class="loader">Verifying credentials...</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, doc, getDoc, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBygHYMOSuKueZf9nE5LmSwCyCeZ2dNeD0",
      authDomain: "career-intelligence-system.firebaseapp.com",
      projectId: "career-intelligence-system",
      storageBucket: "career-intelligence-system.firebasestorage.app",
      messagingSenderId: "223785446772",
      appId: "1:223785446772:web:0f9ded4e89a978fc551021"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // 1. Populate Schools Dropdown
    async function loadSchools() {
        const select = document.getElementById('stuSchool');
        const snap = await getDocs(collection(db, "schools"));
        snap.forEach(docSnap => {
            const option = document.createElement('option');
            option.value = docSnap.id;
            option.text = docSnap.data().formattedName || docSnap.data().name;
            select.appendChild(option);
        });
    }

    // 2. Register Student Logic
    window.registerStudent = async function() {
        const name = document.getElementById('stuName').value;
        const schoolId = document.getElementById('stuSchool').value;
        const inputCode = document.getElementById('stuCode').value.trim();
        const grade = document.getElementById('stuGrade').value;
        const status = document.getElementById('status');

        if(!name || !schoolId || !inputCode) return alert("Please fill all fields.");

        status.style.display = "block";

        try {
            // Check School Code in the database
            const schoolRef = doc(db, "schools", schoolId);
            const schoolSnap = await getDoc(schoolRef);
            
            // For now, we assume the code is stored in school metadata
            // e.g., 'accessCode' field in the 'schools' collection
            const masterCode = schoolSnap.data().accessCode || "JOIN123"; 

            if (inputCode !== masterCode) {
                alert("Invalid Access Code. Please check with your teacher.");
                status.style.display = "none";
                return;
            }

            // Create Student Profile linked to this school
            const user = auth.currentUser; 
            await setDoc(doc(db, "students", user.uid), {
                name: name,
                email: user.email,
                schoolId: schoolId,
                grade: grade,
                joinedAt: new Date().toISOString(),
                status: "Active",
                assessmentCompleted: false
            });

            alert("Welcome aboard! Redirecting to your portal.");
            window.location.href = "student_portal.html";

        } catch (e) {
            console.error(e);
            alert("Registration failed. Are you logged in with Google first?");
            status.style.display = "none";
        }
    };

    loadSchools();
</script>
</body>
</html>
