<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Student Registration | Career Intel</title>
    <style>
      :root {
        --bg: #0f172a; --card-bg: #1e293b; --primary: #6366f1; 
        --text-main: #f8fafc; --text-muted: #94a3b8; --border: #334155;
      }
      body { background: var(--bg); font-family: 'Nunito', sans-serif; color: var(--text-main); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
      .reg-card { background: var(--card-bg); padding: 40px; border-radius: 20px; border: 1px solid var(--border); width: 100%; max-width: 450px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
      h1 { margin-top: 0; font-size: 1.8rem; text-align: center; background: linear-gradient(to right, #818cf8, #c084fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
      .form-group { margin-bottom: 20px; }
      label { display: block; margin-bottom: 8px; font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; font-weight: bold; }
      .form-input, .form-select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: #0f172a; color: white; box-sizing: border-box; }
      .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; background: var(--primary); color: white; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.3s; }
      .btn:hover { opacity: 0.9; transform: translateY(-2px); }
      .loader { text-align: center; font-size: 0.9rem; color: var(--primary); margin-top: 15px; display: none; font-weight: bold;}
    </style>
</head>
<body>

<div class="reg-card">
    <h1>Complete Your Profile</h1>
    <p style="text-align: center; color: var(--text-muted); font-size: 0.9rem; margin-bottom: 30px;">Set up your account to access your career dashboard.</p>

    <div class="form-group">
        <label>Full Name</label>
        <input type="text" id="stuName" class="form-input" placeholder="Enter your full name">
    </div>

    <div class="form-group">
        <label>Current Grade / Level</label>
        <select id="stuGrade" class="form-select">
            <option>Grade 8</option>
            <option>Grade 9</option>
            <option selected>Grade 10</option>
            <option>Grade 11</option>
            <option>Grade 12</option>
            <option>Under Graduate</option>
            <option>Post Graduate</option>
            <option>PhD</option>
        </select>
    </div>

    <div style="border-top: 1px dashed var(--border); margin: 25px 0; padding-top: 15px;">
        <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0;">If your school partnered with us, select it below. Otherwise, leave these blank.</p>
        
        <div class="form-group">
            <label>Select Your Institution <span style="color:#6366f1;">(Optional)</span></label>
            <select id="stuSchool" class="form-select">
                <option value="">-- Independent / General Public --</option>
            </select>
        </div>

        <div class="form-group">
            <label>School Access Code <span style="color:#6366f1;">(Optional)</span></label>
            <input type="text" id="stuCode" class="form-input" placeholder="Provided by your counselor">
        </div>
    </div>

    <button class="btn" onclick="registerStudent()">Start My Journey</button>
    <div id="status" class="loader">Verifying & Creating Profile...</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, doc, getDoc, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBygHYMOSuKueZf9nE5LmSwCyCeZ2dNeD0",
      authDomain: "career-intelligence-system.firebaseapp.com",
      projectId: "career-intelligence-system",
      storageBucket: "career-intelligence-system.firebasestorage.app",
      messagingSenderId: "223785446772",
      appId: "1:223785446772:web:0f9ded4e89a978fc551021"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Make sure we know who is logged in
    let currentUser = null;
    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            // Auto-fill name if Google provided one
            if(user.displayName) {
                document.getElementById('stuName').value = user.displayName;
            }
        } else {
            alert("Authentication missing. Redirecting to home.");
            window.location.href = "index.html";
        }
    });

    // 1. Populate Schools Dropdown
    async function loadSchools() {
        const select = document.getElementById('stuSchool');
        try {
            const snap = await getDocs(collection(db, "schools"));
            snap.forEach(docSnap => {
                const option = document.createElement('option');
                option.value = docSnap.id;
                option.text = docSnap.data().formattedName || docSnap.data().name;
                select.appendChild(option);
            });
        } catch(e) {
            console.error("Error loading schools", e);
        }
    }

    // 2. Register Student Logic
    window.registerStudent = async function() {
        const name = document.getElementById('stuName').value.trim();
        let schoolId = document.getElementById('stuSchool').value;
        const inputCode = document.getElementById('stuCode').value.trim();
        const grade = document.getElementById('stuGrade').value;
        const status = document.getElementById('status');

        if(!name) return alert("Please enter your Full Name.");
        if(!currentUser) return alert("Please wait a moment for authentication to finish linking.");

        status.style.display = "block";

        try {
            // ONLY check the access code if they selected a specific school
            if (schoolId !== "") {
                if(!inputCode) {
                    status.style.display = "none";
                    return alert("You selected a school. Please enter the School Access Code provided by your counselor.");
                }

                const schoolRef = doc(db, "schools", schoolId);
                const schoolSnap = await getDoc(schoolRef);
                
                const masterCode = schoolSnap.exists() ? (schoolSnap.data().accessCode || "JOIN123") : "JOIN123"; 

                if (inputCode !== masterCode) {
                    alert("Invalid Access Code. Please check your typing or contact your teacher.");
                    status.style.display = "none";
                    return;
                }
            } else {
                // If they didn't select a school, assign them to the General Public category
                schoolId = "GENERAL";
            }

            // Create Student Profile
            await setDoc(doc(db, "students", currentUser.uid), {
                name: name,
                email: currentUser.email,
                schoolId: schoolId,
                grade: grade,
                joinedAt: new Date().toISOString(),
                status: "Active",
                assessmentCompleted: false
            });

            alert("Profile Created Successfully! Redirecting to your portal.");
            window.location.href = "student_portal.html";

        } catch (e) {
            console.error(e);
            alert("Registration failed. Check your internet connection.");
            status.style.display = "none";
        }
    };

    loadSchools();
</script>
</body>
</html>
