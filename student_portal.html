<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Student Dashboard | Career Intelligence</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root {
        --bg: #f8fafc; --sidebar: #0f172a; --card-bg: #ffffff; 
        --primary: #3b82f6; --secondary: #10b981; --accent: #f59e0b;
        --text-main: #1e293b; --text-muted: #64748b; --border: #e2e8f0;
        --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
      }
      body { background-color: var(--bg); font-family: 'Nunito', sans-serif; color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden; }
      
      /* --- SIDEBAR --- */
      .sidebar { width: 280px; background: var(--sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow-y: auto; color: white;}
      .profile-info { text-align: center; padding: 30px 20px 20px; border-bottom: 1px solid rgba(255,255,255,0.05); margin-bottom: 10px; position: relative;}
      
      /* Editable Avatar */
      .avatar-wrapper { position: relative; width: 80px; height: 80px; margin: 0 auto 15px; cursor: pointer; }
      .stu-avatar { width: 100%; height: 100%; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: bold; border: 3px solid rgba(255,255,255,0.2); object-fit: cover; transition: 0.3s;}
      .avatar-wrapper:hover .stu-avatar { opacity: 0.7; }
      .avatar-wrapper::after { content: 'üì∑'; position: absolute; bottom: 0; right: 0; background: var(--primary); border-radius: 50%; padding: 4px; font-size: 12px; border: 2px solid var(--sidebar); pointer-events: none;}
      
      .nav-menu { padding: 10px; display: flex; flex-direction: column; gap: 5px; }
      .nav-btn { background: transparent; color: #94a3b8; border: none; text-align: left; padding: 12px 20px; width: 100%; cursor: pointer; border-radius: 12px; font-weight: 800; font-size: 0.95rem; display: flex; align-items: center; gap: 12px; transition: all 0.2s ease;}
      .nav-btn:hover { background: rgba(255,255,255,0.05); color: white; transform: translateX(5px);}
      .nav-btn.active { background: rgba(59, 130, 246, 0.15); color: #60a5fa; border-left: 4px solid #3b82f6; border-radius: 0 12px 12px 0;}

      /* --- MAIN CONTENT & LAYOUT --- */
      .main-wrapper { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
      .top-header { background: white; height: 70px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; padding: 0 40px; box-shadow: 0 4px 20px rgba(0,0,0,0.02);}
      
      .main-content { flex: 1; padding: 40px 50px; overflow-y: auto; position: relative;}
      .tab-content { display: none; animation: fadeIn 0.4s cubic-bezier(0.165, 0.84, 0.44, 1); }
      .tab-content.active { display: block; }
      
      .header-bar { margin-bottom: 40px; display: flex; justify-content: space-between; align-items: flex-end;}
      .header-bar h1 { margin: 0 0 8px 0; font-size: 2.2rem; color: #0f172a; font-weight: 900; letter-spacing: -0.5px;}
      .header-bar p { margin: 0; color: var(--text-muted); font-size: 1.1rem;}

      /* --- UI COMPONENTS --- */
      .card { background: var(--card-bg); padding: 30px; border-radius: 20px; border: 1px solid var(--border); margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); transition: transform 0.3s ease;}
      .card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0,0,0,0.05); }
      .card h3 { margin-top: 0; color: #0f172a; border-bottom: 2px solid #f1f5f9; padding-bottom: 15px; font-size: 1.2rem; font-weight: 800;}
      
      .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
      .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; }
      .grid-3-1 { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; }
      @media (max-width: 900px) { .grid-3-1 { grid-template-columns: 1fr; } }
      
      /* Snapshot Cards */
      .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
      .kpi-box { background: linear-gradient(145deg, #ffffff, #f8fafc); padding: 25px; border-radius: 16px; border: 1px solid var(--border); text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.02);}
      .kpi-box h4 { margin:0 0 15px 0; color:var(--text-muted); font-size:0.85rem; text-transform:uppercase; letter-spacing: 0.5px; font-weight: 800;}
      .kpi-box .val { font-size:2rem; font-weight:900; color: var(--primary); }

      /* Premium Clarity Meter */
      .clarity-meter-wrap { background: radial-gradient(circle at top right, #1e1b4b, #0f172a); color: white; padding: 40px; border-radius: 24px; position: relative; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.1);}
      .clarity-score { font-size: 4rem; font-weight: 900; color: var(--accent); line-height: 1; margin-bottom: 10px; background: -webkit-linear-gradient(45deg, #fbbf24, #f59e0b); -webkit-background-clip: text; -webkit-text-fill-color: transparent;}
      .meter-bg { width: 100%; height: 12px; background: rgba(255,255,255,0.1); border-radius: 10px; margin-top: 25px; overflow: hidden;}
      .meter-fill { height: 100%; background: linear-gradient(90deg, #fcd34d, #f59e0b); width: 40%; border-radius: 10px; box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);}

      .btn { background: linear-gradient(45deg, var(--primary), #60a5fa); color: white; border: none; padding: 14px 28px; font-size: 1.05rem; font-weight: 800; border-radius: 12px; cursor: pointer; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: inline-flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);}
      .btn:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);}
      .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); box-shadow: none;}
      .btn-outline:hover { background: var(--primary); color: white; }

      .status-pill { padding: 6px 16px; border-radius: 50px; font-weight: 800; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px;}
      .status-success { background: #d1fae5; color: #059669; }
      .status-warning { background: #fef3c7; color: #d97706; }
      .status-pending { background: #f1f5f9; color: #64748b; }

      /* Action Plan Tasks */
      .task-item { display: flex; align-items: center; gap: 20px; padding: 20px; border-bottom: 1px dashed var(--border); transition: 0.2s;}
      .task-item:hover { background: #f8fafc; border-radius: 12px; border-bottom-color: transparent;}
      .task-item:last-child { border: none; }
      .task-checkbox { width: 24px; height: 24px; cursor: pointer; accent-color: var(--primary);}

      /* Form Elements */
      .form-group { margin-bottom: 20px; }
      .form-label { display: block; font-weight: 800; margin-bottom: 8px; color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px;}
      .form-input, .form-select { width: 100%; padding: 14px; border-radius: 10px; border: 2px solid var(--border); background: #f8fafc; color: #0f172a; box-sizing: border-box; font-family: inherit; font-size: 1rem; transition: 0.3s;}
      .form-input:focus, .form-select:focus { border-color: var(--primary); outline: none; background: white; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);}

      /* Chat Styles */
      .chat-message { padding: 12px 18px; border-radius: 12px; margin-bottom: 12px; font-size: 0.95rem; max-width: 85%; line-height: 1.5;}
      .chat-student { background: var(--primary); color: white; margin-left: auto; border-bottom-right-radius: 0; box-shadow: 0 4px 10px rgba(59,130,246,0.2);}
      .chat-counsellor { background: #f1f5f9; color: #1e293b; margin-right: auto; border-bottom-left-radius: 0; border: 1px solid var(--border);}
      .chat-time { font-size: 0.75rem; opacity: 0.7; margin-top: 6px; text-align: right; display: block;}

      @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="profile-info">
        <div class="avatar-wrapper" onclick="document.getElementById('photoUpload').click()" title="Change Profile Picture">
            <img class="stu-avatar" id="stuAvatarImg" style="display:none;">
            <div class="stu-avatar" id="stuInitials">--</div>
        </div>
        <input type="file" id="photoUpload" style="display: none;" accept="image/png, image/jpeg">
        
        <h3 id="stuName" style="margin: 0 0 5px 0; font-size: 1.2rem;">Loading Profile...</h3>
        <p id="stuInst" style="font-size:0.85rem; color:#94a3b8; margin:0;">...</p>
        
        <div style="margin-top: 20px; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px;">
            <span style="font-size:0.75rem; color: #cbd5e1; text-transform:uppercase; font-weight:800; letter-spacing: 1px;">Profile Setup</span>
            <div style="width:100%; height:8px; background:rgba(255,255,255,0.1); border-radius:4px; margin-top:8px; overflow:hidden;">
                <div style="width:40%; height:100%; background:var(--success); border-radius:4px;"></div>
            </div>
        </div>
    </div>
    
    <nav class="nav-menu">
        <button class="nav-btn active" onclick="switchTab('tab-home', this)">üè† Dashboard</button>
        <button class="nav-btn" onclick="switchTab('tab-report', this)">üìÑ My Career Report</button>
        <button class="nav-btn" onclick="switchTab('tab-assessment', this)">üìù My Assessment</button>
        <button class="nav-btn" onclick="switchTab('tab-action', this)">üéØ Action Plan</button>
        <button class="nav-btn" onclick="switchTab('tab-portfolio', this)">üìÅ My Portfolio</button>
        <button class="nav-btn" onclick="switchTab('tab-counselling', this)">üìÖ Book Counselling</button>
        <button class="nav-btn" onclick="switchTab('tab-chat', this)">üí¨ Direct Chat</button>
        <button class="nav-btn" onclick="switchTab('tab-tracker', this)">üìà Progress Tracker</button>
        
        <div style="border-top: 1px solid rgba(255,255,255,0.05); margin: 15px 0;"></div>
        
        <button class="nav-btn" onclick="switchTab('tab-settings', this)">‚öôÔ∏è Profile Settings</button>
        <button class="nav-btn" style="color: #f87171;" id="logoutBtn">üö™ Secure Logout</button>
    </nav>
</div>

<div class="main-wrapper">
    <div class="top-header">
        <h2 style="margin:0; font-size:1.2rem; color:var(--text-muted); font-weight:800;" id="headerTitle">Dashboard Home</h2>
        <div style="display:flex; align-items:center; gap:15px;">
            <span class="status-pill status-success" style="background: rgba(16, 185, 129, 0.1);">üü¢ System Online</span>
        </div>
    </div>

    <div class="main-content">
        
        <div id="tab-home" class="tab-content active">
            <div class="header-bar">
                <div>
                    <h1 id="welcomeText">Welcome back, Student!</h1>
                    <p>Let's take the next step toward your future today.</p>
                </div>
                <a href="career-assessment.html" class="btn">Start Assessment ‚ûî</a>
            </div>

            <div class="grid-2" style="grid-template-columns: 1fr 1.5fr;">
                
                <div class="clarity-meter-wrap">
                    <h3 style="margin-top:0; color:white; border:none; opacity:0.8; font-size:1rem; text-transform:uppercase; letter-spacing: 1px;">Career Clarity Score</h3>
                    <div class="clarity-score">4 <span style="font-size:1.8rem; color:#64748b;">/ 10</span></div>
                    <p style="color:#cbd5e1; font-size:1rem; line-height: 1.6; margin-bottom:0;">Your clarity is low. Taking the psychometric assessment will instantly analyze your traits and boost your score.</p>
                    <div class="meter-bg"><div class="meter-fill"></div></div>
                    
                    <div style="margin-top: 30px; padding-top: 25px; border-top: 1px dashed rgba(255,255,255,0.1);">
                        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                            <span style="color:#94a3b8; font-size:0.9rem; font-weight:bold; text-transform:uppercase;">Confidence Level</span>
                            <strong style="color:white; font-size:1.1rem;">Moderate</strong>
                        </div>
                        <div style="display:flex; justify-content:space-between;">
                            <span style="color:#94a3b8; font-size:0.9rem; font-weight:bold; text-transform:uppercase;">Status</span>
                            <strong style="color:var(--warning); font-size:1.1rem;">Assessment Pending</strong>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="kpi-grid">
                        <div class="kpi-box" style="border-top: 4px solid var(--warning);"><h4>Assessment Status</h4><div class="val" style="color:var(--warning); font-size:1.4rem; margin-top:10px;">Action Needed</div></div>
                        <div class="kpi-box" style="border-top: 4px solid var(--primary);"><h4>Next Session</h4><div class="val" style="color:#0f172a; font-size:1.4rem; margin-top:10px;">Not Booked</div></div>
                        <div class="kpi-box" style="border-top: 4px solid var(--success);"><h4>Action Plan</h4><div class="val" style="color:#0f172a; font-size:1.4rem; margin-top:10px;">0%</div></div>
                    </div>

                    <div class="card" style="margin-bottom:0; background: linear-gradient(to right, #eff6ff, #ffffff); border-color: #bfdbfe; border-left: 4px solid var(--primary);">
                        <h3 style="border:none; color: var(--primary); margin-bottom: 10px;">üåü Weekly Career Tip</h3>
                        <p style="color: #1e293b; margin-bottom: 0; line-height: 1.6; font-size: 1.05rem;"><strong>Did you know?</strong> 65% of students change their major in college because they didn't align their core personality with their initial choice. Discover your RIASEC type in the Assessment tab to avoid this trap!</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-report" class="tab-content">
            <div class="header-bar">
                <div><h1>My Career Report</h1><p>Your personalized, AI-driven career and stream analysis.</p></div>
                <button class="btn btn-outline" disabled style="opacity:0.5; cursor:not-allowed;">üîí Download PDF</button>
            </div>
            
            <div class="card" style="text-align:center; padding: 80px 20px;">
                <div style="font-size: 5rem; margin-bottom: 20px; opacity: 0.8;">üìÑ</div>
                <h2 style="color: #0f172a; font-size: 2rem; margin-bottom: 15px;">Report Locked</h2>
                <p style="color: var(--text-muted); font-size: 1.1rem; max-width: 600px; margin: 0 auto 30px; line-height: 1.6;">You need to complete your Clinical Psychometric Assessment before the AI can generate your personalized Career Report.</p>
                <a href="career-assessment.html" class="btn" style="padding: 15px 35px;">Take Assessment Now ‚ûî</a>
            </div>
        </div>

        <div id="tab-assessment" class="tab-content">
            <div class="header-bar"><h1>Clinical Assessment</h1><p>75-point psychometric evaluation to map your future.</p></div>
            
            <div class="card" style="border-top: 5px solid var(--primary);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 25px;">
                    <h3 style="border:none; padding:0; margin:0; font-size:1.5rem;">Current Status</h3>
                    <span class="status-pill status-warning" style="font-size: 1rem; padding: 8px 20px;">Not Started</span>
                </div>
                
                <p style="color: var(--text-muted); font-size: 1.1rem; line-height: 1.7; margin-bottom: 30px;">This assessment measures your RIASEC traits, inherent aptitudes, and emotional resilience. There are no right or wrong answers. Ensure you are in a quiet room and have 25 minutes to complete the test.</p>
                
                <div style="background: #f8fafc; padding: 30px; border-radius: 16px; margin-bottom: 30px; border: 1px solid var(--border);">
                    <h4 style="margin-top:0; font-size: 1.2rem; color: #0f172a;">Modules Included:</h4>
                    <ul style="color: var(--text-muted); font-size: 1.05rem; line-height: 2; margin-bottom: 0;">
                        <li><strong>Interest Test:</strong> Discovers what you naturally enjoy doing.</li>
                        <li><strong>Personality Map:</strong> Analyzes how you interact with work and people.</li>
                        <li><strong>Aptitude Check:</strong> Measures your problem-solving logic.</li>
                    </ul>
                </div>
                
                <a href="career-assessment.html" class="btn" style="width: 100%; justify-content: center; padding: 18px; font-size: 1.2rem;">Begin Full Assessment ‚ûî</a>
            </div>
        </div>

        <div id="tab-action" class="tab-content">
            <div class="header-bar"><h1>My Action Plan</h1><p>Turn your career insights into daily execution.</p></div>
            
            <div class="card">
                <h3>Skill Development Tasks</h3>
                <p style="color:var(--text-muted); font-size:1rem; margin-top:-5px; margin-bottom:30px;">Complete your assessment to get personalized tasks. Below are general suggestions.</p>
                
                <div class="task-item">
                    <input type="checkbox" class="task-checkbox">
                    <div style="flex:1;">
                        <strong style="display:block; color:#0f172a; font-size: 1.1rem; margin-bottom: 4px;">Complete Profile Setup</strong>
                        <span style="font-size:0.9rem; color:var(--text-muted);">Add your parent contact info in settings.</span>
                    </div>
                    <span class="status-pill status-pending">Pending</span>
                </div>
                <div class="task-item">
                    <input type="checkbox" class="task-checkbox">
                    <div style="flex:1;">
                        <strong style="display:block; color:#0f172a; font-size: 1.1rem; margin-bottom: 4px;">Take Psychometric Assessment</strong>
                        <span style="font-size:0.9rem; color:var(--text-muted);">Unlock your career report.</span>
                    </div>
                    <span class="status-pill status-warning">High Priority</span>
                </div>
            </div>
        </div>

        <div id="tab-portfolio" class="tab-content">
            <div class="header-bar">
                <div><h1>My Portfolio</h1><p>Build your long-term academic and extracurricular profile.</p></div>
                <button class="btn btn-outline">+ Add Achievement</button>
            </div>
            <div class="card" style="text-align:center; padding: 80px 20px;">
                <div style="font-size: 4rem; margin-bottom: 20px; opacity: 0.5;">üèÜ</div>
                <p style="color:var(--text-muted); font-size: 1.1rem; max-width: 500px; margin: 0 auto;">Your portfolio is currently empty. Start adding your Olympiad scores, sports certificates, or school projects to build a strong resume!</p>
            </div>
        </div>

        <div id="tab-counselling" class="tab-content">
            <div class="header-bar"><h1>Book Counselling</h1><p>Schedule a 1-on-1 session with your clinical expert.</p></div>
            <div class="grid-2">
                <div class="card" style="border-top: 5px solid var(--secondary);">
                    <h3>Schedule New Session</h3>
                    
                    <div class="form-group">
                        <label class="form-label">Select Expert Counsellor</label>
                        <select class="form-select" id="bookCounsellorSelect" onchange="showCounsellorTimes(this.value)">
                            <option value="">-- Choose Counsellor --</option>
                        </select>
                    </div>

                    <div id="bookingAvailInfo" style="margin-bottom: 20px; padding: 15px; background: #eff6ff; border-left: 4px solid var(--primary); border-radius: 8px; color: #1e3a8a; display:none;">
                        <strong style="display:block; margin-bottom: 5px;">Availability:</strong>
                        <span id="bookingTimeText" style="font-size: 0.95rem;">Select a counsellor to view availability.</span>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Preferred Format</label>
                        <select class="form-select"><option>Online (Video Call)</option><option>Offline (In School)</option></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Topic of Discussion</label>
                        <select class="form-select"><option>Stream Selection</option><option>Report Explanation</option><option>Stress / Confusion</option></select>
                    </div>
                    <button class="btn" style="width:100%; justify-content:center; padding: 15px;">Book Selected Slot</button>
                </div>
                <div class="card">
                    <h3>Session History</h3>
                    <div style="text-align:center; padding: 40px 20px;">
                        <span style="font-size: 3rem; opacity: 0.5;">üìÖ</span>
                        <p style="color:var(--text-muted); margin-top: 15px; font-size: 1.05rem;">No past sessions recorded.</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-chat" class="tab-content">
            <div class="header-bar"><h1>Direct Counsellor Chat</h1><p>Get quick answers from your assigned career experts.</p></div>
            <div class="grid-3-1">
                <div class="card" style="padding:0; overflow:hidden; display:flex; flex-direction:column; height:60vh; border-top: 5px solid var(--primary);">
                    
                    <div style="padding: 20px 25px; border-bottom: 1px solid var(--border); background: #f8fafc;">
                        <div class="form-group" style="margin:0;">
                            <label class="form-label" style="font-size:0.8rem;">Select Counsellor to message</label>
                            <select class="form-select" id="studentChatSelect" onchange="loadCounsellorChat(this.value)">
                                <option value="">-- Choose a Counsellor --</option>
                            </select>
                        </div>
                        <p id="counsellorReplyText" style="font-size: 0.85rem; color: var(--success); margin: 10px 0 0 0; font-weight: bold; display: none;">üü¢ Typically replies within 2 hours</p>
                    </div>
                    
                    <div style="flex:1; padding: 25px; overflow-y:auto; background: #ffffff;" id="studentChatMessages">
                        <div style="text-align:center; color:var(--text-muted); margin-top:40px; font-size: 1.1rem;">Please select a counsellor from the dropdown to start chatting.</div>
                    </div>
                    
                    <div style="padding: 20px 25px; border-top: 1px solid var(--border); display:flex; gap:15px; background: #f8fafc;">
                        <input type="text" id="studentChatInput" class="form-input" placeholder="Type your message here..." style="margin:0; background:white;">
                        <button class="btn" onclick="sendStudentChatMessage()" style="padding: 0 30px;">Send</button>
                    </div>
                </div>
                
                <div>
                    <div class="card">
                        <h3>Expert Profile</h3>
                        <div id="counsellorProfileCard" style="text-align:center; color:var(--text-muted); padding: 20px 0;">
                            Select a counsellor to view their profile credentials and available office hours.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-tracker" class="tab-content">
            <div class="header-bar"><h1>Progress Tracker</h1><p>Visualizing your journey to career clarity.</p></div>
            <div class="card">
                <h3>Clarity Score Trend</h3>
                <div style="text-align:center; padding: 60px 20px; background: #f8fafc; border-radius: 12px; margin-top: 20px; border: 1px dashed var(--border);">
                    <span style="font-size: 3rem; opacity: 0.5;">üìà</span>
                    <p style="color:var(--text-muted); font-size: 1.1rem; max-width: 500px; margin: 15px auto 0;">Take your first assessment to establish a baseline score. Your growth graph will appear here.</p>
                </div>
            </div>
        </div>

        <div id="tab-settings" class="tab-content">
            <div class="header-bar"><h1>Profile Settings</h1><p>Manage your account details and preferences.</p></div>
            <div class="card" style="border-top: 5px solid var(--primary);">
                <h3 style="margin-bottom: 25px;">Account Information</h3>
                <div class="grid-2" style="margin-bottom: 25px;">
                    <div class="form-group"><label class="form-label">Full Name</label><input type="text" id="setStuName" class="form-input" readonly style="background: #f1f5f9; color: #64748b;"></div>
                    <div class="form-group"><label class="form-label">Registered Email</label><input type="text" id="setStuEmail" class="form-input" readonly style="background: #f1f5f9; color: #64748b;"></div>
                </div>
                
                <h3 style="margin-top: 40px; margin-bottom: 25px;">Parent / Guardian Contact</h3>
                <div class="grid-2">
                    <div class="form-group"><label class="form-label">Parent Name</label><input type="text" class="form-input" placeholder="Enter parent's name"></div>
                    <div class="form-group"><label class="form-label">Parent Phone / WhatsApp</label><input type="text" class="form-input" placeholder="+91 XXXXX XXXXX"></div>
                </div>
                <button class="btn" style="margin-top:30px; padding: 15px 30px;">üíæ Save Details</button>
            </div>
        </div>

    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

    // ‚ö†Ô∏è REPLACE WITH YOUR ACTUAL CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyBygHYMOSuKueZf9nE5LmSwCyCeZ2dNeD0",
      authDomain: "career-intelligence-system.firebaseapp.com",
      projectId: "career-intelligence-system",
      storageBucket: "career-intelligence-system.firebasestorage.app",
      messagingSenderId: "223785446772",
      appId: "1:223785446772:web:0f9ded4e89a978fc551021",
      measurementId: "G-HGKJJN9KDF"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    let activeUserUid = null;
    window.globalCounsellors = {};

    // --- TAB NAVIGATION LOGIC ---
    window.switchTab = function(tabId, btn) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        btn.classList.add('active');
        document.getElementById('headerTitle').innerText = btn.innerText.replace(/[^\w\s]/gi, '').trim();
    };

    // --- LOAD COUNSELLORS INTO DROPDOWNS ---
    async function loadCounsellors() {
        const chatSelect = document.getElementById('studentChatSelect');
        const bookSelect = document.getElementById('bookCounsellorSelect');
        
        try {
            const snap = await getDocs(collection(db, "counsellor_profiles"));
            if(!snap.empty) {
                chatSelect.innerHTML = '<option value="">-- Choose a Counsellor --</option>';
                bookSelect.innerHTML = '<option value="">-- Choose an Expert --</option>';
                
                snap.forEach(docSnap => {
                    const data = docSnap.data();
                    window.globalCounsellors[docSnap.id] = data;
                    const optionHtml = `<option value="${docSnap.id}">${data.name || docSnap.id} - ${data.title || 'Counsellor'}</option>`;
                    chatSelect.innerHTML += optionHtml;
                    bookSelect.innerHTML += optionHtml;
                });
            } else {
                // Dummy fallback for UI testing if database is empty
                const dummyHtml = `<option value="dummy1">Dr. Smith - Lead Counsellor</option><option value="dummy2">Sarah Jenkins - Admissions Expert</option>`;
                chatSelect.innerHTML += dummyHtml;
                bookSelect.innerHTML += dummyHtml;
                window.globalCounsellors['dummy1'] = { name: 'Dr. Smith', title: 'Lead Clinical Counsellor', bio: 'Expert in psychometrics and stream transition.', photo: 'https://ui-avatars.com/api/?name=Dr+Smith&background=3b82f6&color=fff' };
                window.globalCounsellors['dummy2'] = { name: 'Sarah Jenkins', title: 'Admissions Expert', bio: 'Specializes in Ivy League and Study Abroad.', photo: 'https://ui-avatars.com/api/?name=Sarah+Jenkins&background=10b981&color=fff' };
            }
        } catch(e) {
            console.error("Error loading counsellors:", e);
        }
    }

    // --- STUDENT CHAT LOGIC ---
    window.loadCounsellorChat = function(counsellorId) {
        if(!counsellorId) return;
        const c = window.globalCounsellors[counsellorId];
        const studentFirstName = document.getElementById('stuName').innerText.split(' ')[0] || "Student";
        
        // Update Profile Card Sidebar
        const profileCard = document.getElementById('counsellorProfileCard');
        if(c) {
            profileCard.innerHTML = `
                <img src="${c.photo || 'https://via.placeholder.com/150'}" style="width:120px; height:120px; border-radius:50%; object-fit:cover; border:4px solid var(--primary); margin-bottom:15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                <h4 style="margin:0; color:#0f172a; font-size:1.2rem;">${c.name}</h4>
                <p style="font-size:0.9rem; margin:5px 0; color:var(--primary); font-weight:bold;">${c.title || 'Clinical Counsellor'}</p>
                <p style="font-size:0.85rem; line-height:1.5;">${c.bio || 'Dedicated to helping you find your perfect career path.'}</p>
                
                <div style="background:#f8fafc; padding:15px; border-radius:12px; margin-top:20px; text-align:left; border:1px solid var(--border);">
                    <strong style="font-size:0.8rem; color:var(--secondary); display:block; margin-bottom:5px;">üïí AVAILABILITY (OFFICE HOURS)</strong>
                    <span style="font-size:0.9rem; color:#0f172a; font-weight:bold;">Mon, Wed, Fri</span><br>
                    <span style="font-size:0.9rem; color:#64748b;">14:00 PM - 18:00 PM</span>
                </div>
            `;
        }

        document.getElementById('counsellorReplyText').style.display = 'block';

        // Load Mock Chat History
        const chatBox = document.getElementById('studentChatMessages');
        chatBox.innerHTML = `
            <div style="text-align:center; color:var(--text-muted); margin-bottom: 25px; font-size:0.85rem; padding: 5px 15px; background: #f1f5f9; border-radius: 50px; display:inline-block; margin-left: 50%; transform: translateX(-50%);">üîí Secure connection established with ${c ? c.name : 'your counsellor'}.</div>
            
            <div class="chat-message chat-counsellor">
                Hi ${studentFirstName}! I'll be your designated career counsellor. Let me know if you need any help understanding your assessment report or picking a stream.
                <span class="chat-time">Yesterday, 10:30 AM</span>
            </div>
        `;
    }

    window.sendStudentChatMessage = function() {
        const input = document.getElementById('studentChatInput');
        const msg = input.value.trim();
        const cid = document.getElementById('studentChatSelect').value;
        
        if(!msg) return;
        if(!cid) return alert("Please select a counsellor from the dropdown menu first.");

        const chatBox = document.getElementById('studentChatMessages');
        chatBox.innerHTML += `
            <div class="chat-message chat-student">
                ${msg}
                <span class="chat-time" style="color:rgba(255,255,255,0.7);">Just now</span>
            </div>
        `;
        input.value = "";
        chatBox.scrollTop = chatBox.scrollHeight;
    }
    
    // --- BOOKING LOGIC ---
    window.showCounsellorTimes = function(cid) {
        const infoBox = document.getElementById('bookingAvailInfo');
        if(cid) {
            infoBox.style.display = 'block';
            document.getElementById('bookingTimeText').innerText = "Mon, Wed, Fri | 14:00 PM - 18:00 PM"; 
        } else {
            infoBox.style.display = 'none';
        }
    }

    // --- PROFILE PICTURE UPLOAD LOGIC ---
    document.getElementById('photoUpload').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file || !activeUserUid) return;
        
        const reader = new FileReader(); 
        reader.readAsDataURL(file);
        reader.onload = function(event) {
            const img = new Image(); 
            img.src = event.target.result;
            img.onload = async function() {
                const canvas = document.createElement('canvas');
                const scaleSize = 150 / img.width; 
                canvas.width = 150; 
                canvas.height = img.height * scaleSize;
                const ctx = canvas.getContext('2d'); 
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                const base64Image = canvas.toDataURL("image/jpeg", 0.8);
                
                document.getElementById('stuAvatarImg').src = base64Image;
                document.getElementById('stuAvatarImg').style.display = 'block';
                document.getElementById('stuInitials').style.display = 'none';
                
                try {
                    await setDoc(doc(db, "students", activeUserUid), { photo: base64Image }, { merge: true });
                } catch(err) {
                    console.error("Failed to save picture", err);
                }
            }
        };
    });

    // --- FIREBASE AUTH & DATA LOADING ---
    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            window.location.href = "index.html"; 
            return;
        }
        
        activeUserUid = user.uid;
        loadCounsellors();

        try {
            const studentRef = doc(db, "students", user.uid);
            const studentSnap = await getDoc(studentRef);

            if (studentSnap.exists()) {
                const data = studentSnap.data();
                
                const firstName = data.name.split(' ')[0];
                document.getElementById('stuName').innerText = data.name;
                document.getElementById('welcomeText').innerText = `Welcome back, ${firstName}!`;
                
                if(data.photo) {
                    document.getElementById('stuAvatarImg').src = data.photo;
                    document.getElementById('stuAvatarImg').style.display = 'block';
                    document.getElementById('stuInitials').style.display = 'none';
                } else {
                    document.getElementById('stuInitials').innerText = firstName.charAt(0).toUpperCase();
                }
                
                document.getElementById('setStuName').value = data.name;
                document.getElementById('setStuEmail').value = data.email;

                if (data.schoolId && data.schoolId !== "GENERAL") {
                    const schoolSnap = await getDoc(doc(db, "schools", data.schoolId));
                    if (schoolSnap.exists()) {
                        document.getElementById('stuInst').innerText = `${schoolSnap.data().name} | Grade ${data.grade}`;
                    }
                } else {
                    document.getElementById('stuInst').innerText = `Independent Student | Grade ${data.grade}`;
                }

            } else {
                window.location.href = "register.html";
            }
        } catch (error) {
            console.error("Data load failed:", error);
        }
    });

    // --- LOGOUT LOGIC ---
    document.getElementById('logoutBtn').addEventListener('click', () => {
        if(confirm("Are you sure you want to log out?")) {
            signOut(auth).then(() => {
                window.location.href = "index.html";
            });
        }
    });

</script>
</body>
</html>
