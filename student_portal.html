<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Student Dashboard | Career Intelligence</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root {
        --bg: #f8fafc; --sidebar: #0f172a; --card-bg: #ffffff; 
        --primary: #3b82f6; --secondary: #10b981; --accent: #f59e0b;
        --text-main: #334155; --text-muted: #64748b; --border: #e2e8f0;
        --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
      }
      body { background-color: var(--bg); font-family: 'Nunito', sans-serif; color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden; }
      
      /* --- SIDEBAR --- */
      .sidebar { width: 280px; background: var(--sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow-y: auto; color: white; transition: 0.3s;}
      .profile-info { text-align: center; padding: 30px 20px 20px; border-bottom: 1px solid rgba(255,255,255,0.02); margin-bottom: 10px; position: relative;}
      
      .avatar-wrapper { position: relative; width: 80px; height: 80px; margin: 0 auto 15px; cursor: pointer; }
      .stu-avatar { width: 100%; height: 100%; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: bold; border: 3px solid rgba(255,255,255,0.1); object-fit: cover; transition: 0.3s;}
      .avatar-wrapper:hover .stu-avatar { opacity: 0.7; }
      
      .nav-menu { padding: 10px; display: flex; flex-direction: column; gap: 5px; }
      .nav-btn { background: transparent; color: #94a3b8; border: none; text-align: left; padding: 12px 20px; width: 100%; cursor: pointer; border-radius: 12px; font-weight: 700; font-size: 0.95rem; display: flex; align-items: center; transition: all 0.2s ease;}
      .nav-btn:hover { background: rgba(255,255,255,0.03); color: white; transform: translateX(3px);}
      .nav-btn.active { background: rgba(59, 130, 246, 0.1); color: #60a5fa; border-left: 3px solid #3b82f6; border-radius: 0 12px 12px 0;}
      .nav-dot { width: 20px; display: inline-block; font-size: 0.85rem; opacity: 0.7; }
      .nav-btn.active .nav-dot { opacity: 1; }

      /* --- MAIN CONTENT & LAYOUT --- */
      .main-wrapper { flex: 1; display: flex; flex-direction: column; overflow: hidden; transition: border 0.3s ease; border-top: 0px solid var(--warning); position: relative;}
      .top-header { background: white; height: 75px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; padding: 0 50px; box-shadow: 0 2px 10px rgba(0,0,0,0.01); z-index: 10;}
      
      /* CLEAN PARENT MODE UI */
      body.parent-mode-active .main-wrapper { border-top: 5px solid var(--warning); }
      body.parent-mode-active .hide-from-parent { display: none !important; }
      body.parent-mode-active .form-input, body.parent-mode-active .form-select, body.parent-mode-active .form-textarea { 
          background: transparent; border: none; padding: 0; font-weight: bold; color: var(--primary); pointer-events: none; -webkit-appearance: none; appearance: none;
      }

      /* --- NOTIFICATION UI --- */
      .header-actions { display: flex; align-items: center; gap: 20px; }
      .notif-bell { position: relative; font-size: 1.3rem; cursor: pointer; transition: 0.2s; opacity: 0.8;}
      .notif-bell:hover { transform: scale(1.1); opacity: 1;}
      .notif-badge { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; font-size: 0.65rem; font-weight: bold; width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; display: none; border: 2px solid white;}
      
      /* Toast Notifications */
      .toast-container { position: absolute; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
      .toast { background: white; border-left: 4px solid var(--primary); padding: 15px 20px; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); animation: slideInRight 0.3s ease forwards; display: flex; flex-direction: column; min-width: 250px; cursor: pointer;}
      .toast-title { font-weight: 800; color: #0f172a; font-size: 0.95rem; margin-bottom: 3px; }
      .toast-body { font-size: 0.85rem; color: var(--text-muted); }

      .main-content { flex: 1; padding: 50px; overflow-y: auto; position: relative;}
      .tab-content { display: none; animation: fadeIn 0.4s cubic-bezier(0.165, 0.84, 0.44, 1); }
      .tab-content.active { display: block; }
      
      .header-bar { margin-bottom: 40px; display: flex; justify-content: space-between; align-items: flex-end;}
      .header-bar h1 { margin: 0 0 8px 0; font-size: 2rem; color: #0f172a; font-weight: 800; letter-spacing: -0.5px;}
      .header-bar p { margin: 0; color: var(--text-muted); font-size: 1.05rem;}

      /* --- UI COMPONENTS --- */
      .card { background: var(--card-bg); padding: 35px; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.02); transition: transform 0.3s ease;}
      .card h3 { margin-top: 0; color: #0f172a; padding-bottom: 15px; font-size: 1.15rem; font-weight: 800;}
      
      .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
      .grid-2col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; } 
      .grid-3-1 { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; }
      @media (max-width: 1000px) { .grid-2, .grid-3-1, .grid-2col { grid-template-columns: 1fr; } }
      
      /* --- GAMIFICATION --- */
      .badge-container { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;}
      .gamify-badge { background: #f8fafc; color: #94a3b8; padding: 6px 14px; border-radius: 50px; font-size: 0.8rem; font-weight: 700; border: 1px solid transparent; display: flex; align-items: center; gap: 5px; opacity: 0.6; filter: grayscale(100%); transition: 0.4s ease;}
      .gamify-badge.unlocked { opacity: 1; filter: grayscale(0%); background: #fffbeb; color: #d97706;}
      .gamify-badge.unlocked-primary { opacity: 1; filter: grayscale(0%); background: #eff6ff; color: #1e40af;}
      .gamify-badge.unlocked-success { opacity: 1; filter: grayscale(0%); background: #d1fae5; color: #059669;}
      
      .xp-pill { background: rgba(255,255,255,0.18); padding: 4px 12px; border-radius: 50px; font-size: 0.8rem; font-weight: bold; color: #fbbf24; }
      .streak-pill { background: rgba(255,255,255,0.18); padding: 4px 12px; border-radius: 50px; font-size: 0.8rem; font-weight: bold; color: #f87171; }

      /* --- CLARITY METER (Premium Edit) --- */
      .clarity-meter-wrap { background: radial-gradient(circle at top right, #1e1b4b, #0f172a); color: white; padding: 45px; border-radius: 20px; position: relative; overflow: hidden; box-shadow: 0 15px 35px rgba(0,0,0,0.08); display: flex; flex-direction: column;}
      .clarity-score { font-size: 3.2rem; font-weight: 800; color: var(--accent); line-height: 1; margin-bottom: 5px; background: -webkit-linear-gradient(45deg, #fcd34d, #f59e0b); -webkit-background-clip: text; -webkit-text-fill-color: transparent;}
      .meter-bg { width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 10px; margin-top: 25px; overflow: hidden;}
      .meter-fill { height: 100%; background: linear-gradient(90deg, #fcd34d, #f59e0b); width: 0%; border-radius: 10px; box-shadow: 0 0 10px rgba(245, 158, 11, 0.3); transition: width 1.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);}
      .mini-chart-container { height: 50px; margin-top: 20px; width: 100%; opacity: 0.5;}

      /* --- BUTTONS --- */
      .btn { background: var(--primary); color: white; border: none; padding: 12px 24px; font-size: 1rem; font-weight: 700; border-radius: 10px; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none;}
      .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(59, 130, 246, 0.25);}
      .btn:disabled { opacity: 0.5; cursor: not-allowed; }
      .btn-outline { background: transparent; border: 1px solid var(--border); color: #475569; box-shadow: none;}
      .btn-outline:hover:not(:disabled) { border-color: var(--primary); color: var(--primary); background: #f8fafc; transform: translateY(-1px);}

      .status-pill { padding: 4px 12px; border-radius: 50px; font-weight: 700; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;}
      .status-success { background: #d1fae5; color: #059669; }

      /* --- PARENT TOGGLE --- */
      .parent-toggle-wrap { display: flex; align-items: center; gap: 8px; background: #fffbeb; border: 1px solid #fde68a; padding: 6px 14px; border-radius: 50px; cursor: pointer; font-weight: 700; font-size: 0.85rem; color: #d97706; transition: 0.3s;}
      .parent-toggle-wrap:hover { background: #fef3c7; }
      .parent-toggle-wrap.active { background: #d97706; color: white; border-color: #d97706;}

      /* --- TIMELINE & PILLS --- */
      .timeline-container { overflow: hidden; max-height: 0; transition: max-height 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
      .timeline-container.expanded { max-height: 500px; }
      .timeline-wrap { position: relative; margin-top: 10px; padding-left: 30px; border-left: 1px solid #e2e8f0; }
      .timeline-step { position: relative; margin-bottom: 25px; opacity: 0.6; transition: 0.3s;}
      .timeline-step::before { content: ''; position: absolute; left: -35px; top: 0; width: 8px; height: 8px; border-radius: 50%; background: white; border: 2px solid #cbd5e1; transition: 0.3s;}
      .timeline-step.completed { opacity: 1; }
      .timeline-step.completed::before { background: var(--success); border-color: var(--success); box-shadow: 0 0 8px rgba(16,185,129,0.3);}
      .timeline-step h4 { margin: 0 0 5px 0; color: #0f172a; font-size: 1rem; font-weight: 700; }
      .timeline-step p { margin: 0; color: var(--text-muted); font-size: 0.85rem; }

      .career-pill { background: #f8fafc; padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; font-weight: 700; color: #1e293b; transition: 0.2s;}
      .career-pill:hover { background: #f1f5f9;}
      .badge-code { display: inline-block; background: var(--primary); color: white; padding: 6px 20px; border-radius: 50px; font-weight: 900; font-size: 1.4rem; letter-spacing: 2px;}

      /* CHAT STYLES */
      .chat-message { padding: 12px 18px; border-radius: 12px; margin-bottom: 12px; font-size: 0.95rem; max-width: 85%; line-height: 1.5;}
      .chat-student { background: var(--primary); color: white; margin-left: auto; border-bottom-right-radius: 0; box-shadow: 0 4px 10px rgba(59,130,246,0.15);}
      .chat-counsellor { background: #f1f5f9; color: #1e293b; margin-right: auto; border-bottom-left-radius: 0; border: 1px solid var(--border);}
      .chat-time { font-size: 0.75rem; opacity: 0.7; margin-top: 6px; text-align: right; display: block;}

      /* Form Elements */
      .form-group { margin-bottom: 20px; }
      .form-label { display: block; font-weight: 700; margin-bottom: 8px; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px;}
      .form-input, .form-select, .form-textarea { width: 100%; padding: 12px 14px; border-radius: 10px; border: 1px solid var(--border); background: #f8fafc; color: #0f172a; box-sizing: border-box; font-family: inherit; font-size: 0.95rem; transition: 0.3s;}
      .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: #93c5fd; outline: none; background: white; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);}
      
      /* Dynamic Subject Row */
      .subject-row { display: flex; gap: 10px; margin-bottom: 12px; align-items: center; }
      .subject-row .form-group { margin-bottom: 0; flex: 1; }
      .btn-remove-sub { background: #fee2e2; color: #ef4444; border: none; border-radius: 8px; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: 0.2s; font-size: 1.2rem; margin-top: 24px;}
      .btn-remove-sub:hover { background: #fca5a5; color: white; }

      /* Academic Steps UI */
      .step-indicator { display: flex; align-items: center; gap: 15px; margin-bottom: 25px; border-bottom: 2px solid var(--border); padding-bottom: 15px;}
      .step-pill { background: #f1f5f9; color: var(--text-muted); padding: 6px 16px; border-radius: 50px; font-weight: 800; font-size: 0.85rem;}
      .step-pill.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(59,130,246,0.2);}

      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      @keyframes slideInRight { from { opacity: 0; transform: translateX(30px); } to { opacity: 1; transform: translateX(0); } }
      @keyframes badgePop { 0% { transform: scale(0.8); opacity: 0; } 50% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
      @keyframes lockSuccessPop { 0% { transform: scale(0.95); opacity: 0; } 50% { transform: scale(1.02); } 100% { transform: scale(1); opacity: 1; } }
      @keyframes fadeOut { to { opacity: 0; } }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="profile-info">
        <div class="avatar-wrapper" onclick="document.getElementById('photoUpload').click()" title="Change Profile Picture">
            <img class="stu-avatar" id="stuAvatarImg" style="display:none;">
            <div class="stu-avatar" id="stuInitials">--</div>
        </div>
        <input type="file" id="photoUpload" class="hide-from-parent" style="display: none;" accept="image/png, image/jpeg">
        
        <h3 id="stuName" style="margin: 0 0 5px 0; font-size: 1.1rem; font-weight:800;">Loading Profile...</h3>
        <p id="stuInst" style="font-size:0.8rem; color:#94a3b8; margin:0;">...</p>
        
        <div style="margin-top: 20px; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 10px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:0.7rem; color: #cbd5e1; text-transform:uppercase; font-weight:700; letter-spacing: 0.5px;">Setup Progress</span>
                <span style="font-size:0.7rem; color: var(--success); font-weight:bold;" id="sideProfileText">10%</span>
            </div>
            <div style="width:100%; height:6px; background:rgba(255,255,255,0.1); border-radius:4px; margin-top:6px; overflow:hidden;">
                <div style="width:10%; height:100%; background:var(--success); border-radius:4px; transition: 1s ease;" id="sideProfileBar"></div>
            </div>
        </div>
    </div>
    
    <nav class="nav-menu">
        <button class="nav-btn active" onclick="switchTab('tab-home', this)"><span class="nav-dot" id="dot-home">‚úî</span> Dashboard</button>
        <button class="nav-btn" onclick="switchTab('tab-report', this)"><span class="nav-dot" id="dot-report">‚óã</span> Career Report</button>
        <button class="nav-btn" onclick="switchTab('tab-explore', this)"><span class="nav-dot" id="dot-explore">‚óã</span> Career Lab</button>
        <button class="nav-btn" onclick="switchTab('tab-portfolio', this)"><span class="nav-dot" id="dot-portfolio">‚óã</span> Academic Profile</button>
        <button class="nav-btn" onclick="switchTab('tab-counselling', this)"><span class="nav-dot" id="dot-counselling">‚óã</span> Book Expert</button>
        <button class="nav-btn hide-from-parent" onclick="switchTab('tab-chat', this)"><span class="nav-dot" id="dot-chat">‚óã</span> Direct Chat</button>
        
        <div class="hide-from-parent" style="border-top: 1px solid rgba(255,255,255,0.05); margin: 15px 0;"></div>
        <button class="nav-btn hide-from-parent" onclick="switchTab('tab-settings', this)"><span class="nav-dot">‚öô</span> Settings</button>
    </nav>
</div>

<div class="main-wrapper">
    <div class="toast-container" id="toastContainer"></div>

    <div class="top-header">
        <h2 style="margin:0; font-size:1.15rem; color:var(--text-muted); font-weight:800;" id="headerTitle">Dashboard Home</h2>
        <div class="header-actions">
            <div class="notif-bell hide-from-parent" onclick="switchTab('tab-chat', document.querySelectorAll('.nav-btn')[5])">
                üîî <span class="notif-badge" id="notifBadge">0</span>
            </div>

            <div class="parent-toggle-wrap" id="parentToggleBtn" onclick="toggleParentMode()">
                <span id="parentToggleIcon">üë®‚Äçüë©‚Äçüëß</span> <span id="parentToggleText">Parent View</span>
            </div>
            
            <button class="btn btn-outline hide-from-parent" style="color: #ef4444; border-color: #fca5a5; padding: 6px 14px; font-size: 0.85rem;" id="logoutBtnTop">üö™ Logout</button>
        </div>
    </div>

    <div class="main-content">
        
        <div id="tab-home" class="tab-content active">
            <div class="header-bar">
                <div>
                    <h1 id="welcomeText">Welcome back, Student.</h1>
                    <p style="color: var(--text-muted); font-size: 1.05rem;">Every step you complete sharpens your future.</p>
                </div>
            </div>

            <div class="card" id="riskAlertBanner" style="display:none; margin-bottom: 25px; padding: 20px; border-left: 4px solid var(--warning);">
                <h3 id="riskAlertTitle" style="border-bottom: none; padding-bottom: 0; font-size: 1rem; margin-bottom: 5px;">‚ö†Ô∏è Academic Alignment</h3>
                <p id="riskAlertText" style="margin-bottom: 0; font-size: 0.9rem; color: var(--text-muted);"></p>
            </div>

            <div class="grid-2" style="grid-template-columns: 1.2fr 1fr; margin-bottom: 30px;">
                
                <div class="clarity-meter-wrap">
                    <h3 style="margin-top:0; color:white; border:none; opacity:0.6; font-size:0.85rem; text-transform:uppercase; letter-spacing: 1.5px; margin-bottom: 15px;">Your Decision Readiness</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <span id="dynLevelTitle" style="font-size: 1.2rem; font-weight: 800; display:block; color:#cbd5e1; margin-bottom: 5px;">Level 1 - Explorer</span>
                        <div class="clarity-score"><span id="dynClarityScore">1</span><span style="font-size:1.8rem; color:rgba(255,255,255,0.3);">/10</span></div>
                    </div>

                    <p style="color:#f8fafc; font-size:1.05rem; line-height: 1.5; margin-bottom:5px; font-weight: 600;" id="dynClarityText">You are beginning your career discovery journey.</p>
                    <p style="font-size: 0.8rem; color: #94a3b8; margin:0; margin-bottom: 20px;">Ahead of <span id="dynPercentile">18</span>% of students at your stage.</p>
                    
                    <div style="display:flex; gap: 10px; margin-bottom: 15px;">
                        <div class="xp-pill">‚ú® <span id="dynXp">10</span> XP</div>
                        <div class="streak-pill">üî• 3 Day Streak</div>
                    </div>

                    <div class="meter-bg"><div class="meter-fill" id="dynClarityBar"></div></div>
                    <div class="mini-chart-container"><canvas id="miniClarityChart"></canvas></div>
                </div>

                <div style="display: flex; flex-direction: column; gap: 20px;">
                    <div class="card" style="margin: 0; flex: 1; border-top: 4px solid var(--accent); display: flex; flex-direction: column; justify-content: center;">
                        <h4 style="color:var(--accent); text-transform:uppercase; font-size:0.75rem; letter-spacing: 1px; margin: 0 0 10px 0;">üéØ Current Focus</h4>
                        <h2 id="weeklyFocusTitle" style="margin:0 0 10px 0; font-size: 1.4rem; color: #0f172a;">Complete Baseline Profile</h2>
                        <p id="weeklyFocusDesc" style="color:var(--text-muted); font-size:0.95rem; line-height: 1.5; margin-bottom: 20px;">Log your academic scores to help the AI contextualize your upcoming assessment.</p>
                        <button id="weeklyFocusBtn" onclick="switchTab('tab-portfolio', document.querySelectorAll('.nav-btn')[3])" class="btn" style="width:100%; padding: 14px;">Update Academics ‚ûî</button>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-bottom: 30px;">
                <h3 style="border-bottom: none; padding-bottom: 0;">Top Recommended Pathways</h3>
                <div id="dashCareersContainer" style="margin-top: 15px;">
                    <div class="career-pill" style="opacity: 0.5;"><span>Assessment Pending</span> <span>üîí</span></div>
                    <p style="font-size:0.85rem; color:var(--text-muted); margin:10px 0 0 0;">Complete your focus tasks to unlock AI matches.</p>
                </div>
            </div>

            <div style="margin-top: 20px; text-align: center;">
                <button onclick="toggleMilestones()" id="milestoneToggleBtn" style="background: none; border: none; color: var(--primary); font-weight: 700; font-size: 0.9rem; cursor: pointer;">View My Progress ‚¨á</button>
            </div>

            <div id="milestoneSection" class="timeline-container">
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
                    <div class="badge-container" style="margin-bottom: 30px;">
                        <div class="gamify-badge unlocked" id="badge-registered">Registered</div>
                        <div class="gamify-badge" id="badge-academic">Academic Baseline</div>
                        <div class="gamify-badge" id="badge-assessed">Assessed</div>
                        <div class="gamify-badge" id="badge-counselled">Counselled</div>
                        <div class="gamify-badge" id="badge-locked">Path Locked</div>
                    </div>

                    <div class="timeline-wrap">
                        <div class="timeline-step completed">
                            <h4>Phase 1: Foundation</h4>
                            <p>Complete your profile settings and academic background.</p>
                        </div>
                        <div class="timeline-step" id="tl-step-2">
                            <h4>Phase 2: Discovery</h4>
                            <p>Take the Psychometric Assessment to unlock your report.</p>
                        </div>
                        <div class="timeline-step" id="tl-step-3">
                            <h4>Phase 3: Interpretation</h4>
                            <p>Book a 1-on-1 session with your designated career expert.</p>
                        </div>
                        <div class="timeline-step" id="tl-step-4">
                            <h4>Phase 4: Execution</h4>
                            <p>Lock your career path and generate your final timeline.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="lockCareerSection" class="hide-from-parent" style="display:none; margin-top: 30px; background: rgba(0,0,0,0.02); padding: 30px; border-radius: 16px; text-align: center; border: 1px dashed var(--accent);">
                <p style="color: #d97706; font-size: 1.05rem; margin-bottom: 15px; font-weight: 800;">You have achieved Strategy Level! Ready to commit?</p>
                <button onclick="lockFinalCareer()" class="btn" style="background: var(--accent); color: #fff; padding: 14px 40px;">üîí Lock My Final Career Path</button>
            </div>
            
            <div id="careerLockedSuccess" style="display:none; margin-top: 30px; background: #ecfdf5; padding: 30px; border-radius: 16px; text-align: center; border: 1px solid #a7f3d0;">
                <div style="font-size: 3rem; margin-bottom: 10px;">üéä</div>
                <h4 style="margin: 0 0 10px 0; color: var(--success); font-size: 1.4rem; font-weight: 800;">Career Locked Successfully</h4>
                <p style="color: #065f46; font-size: 0.95rem; margin-bottom: 20px;">Your parents and counselor have been notified. Time to execute the plan.</p>
                <button class="btn" style="background: var(--success);" onclick="switchTab('tab-report', document.querySelectorAll('.nav-btn')[1])">üìÑ View Final Execution Report</button>
            </div>
        </div>

        <div id="tab-explore" class="tab-content">
            <div class="header-bar">
                <div><h1>Career Exploration Lab</h1><p>Your personalized university and subject recommendations.</p></div>
                <button class="btn" onclick="window.open('https://antoniovn96.github.io/vidyavantage.github.io/colleges/', '_blank')">Launch Full College GPS ‚ûî</button>
            </div>
            
            <div id="exploreLabDynamicArea">
                <div class="card" style="text-align:center; padding: 60px 20px; border-top: 4px solid var(--secondary);">
                    <div style="font-size: 4rem; opacity: 0.5; margin-bottom: 15px;">üîç</div>
                    <h3 style="justify-content: center; border:none;">Lab Locked</h3>
                    <p style="color:var(--text-muted);">Complete your Psychometric Assessment to unlock personalized recommendations.</p>
                    <button class="btn hide-from-parent" onclick="launchAssessment()" style="margin-top: 15px;">Take Assessment</button>
                </div>
            </div>
        </div>

        <div id="tab-report" class="tab-content">
            <div class="header-bar">
                <div><h1>My Career Report</h1><p>Your personalized, AI-driven psychometric analysis.</p></div>
            </div>
            
            <div id="lockedReportUI" class="card" style="text-align:center; padding: 80px 20px;">
                <div style="font-size: 5rem; margin-bottom: 20px; opacity: 0.8;">üìÑ</div>
                <h2 style="color: #0f172a; font-size: 1.8rem; margin-bottom: 15px;">Report Locked</h2>
                <p style="color: var(--text-muted); font-size: 1rem; max-width: 600px; margin: 0 auto 30px; line-height: 1.6;">You need to complete your Psychometric Assessment before the AI can generate your personalized Career Report.</p>
                <button onclick="launchAssessment()" class="btn hide-from-parent" style="padding: 15px 35px;">Take Assessment Now ‚ûî</button>
            </div>

            <div id="unlockedReportUI" style="display:none;" class="report-render-area">
                <div class="grid-2">
                    <div class="card">
                        <h3>üß† Psychometric Profile</h3>
                        <div style="margin-bottom: 20px;">
                            <span class="badge-code" id="reportRiasecCode"></span>
                        </div>
                        <p id="reportProfileDesc" style="color: #334155; line-height: 1.6; font-size: 0.95rem;"></p>
                        <div style="height: 250px; width: 100%; margin-top:20px;">
                            <canvas id="reportRiasecChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>üéØ Recommended Pathways</h3>
                        <p style="font-size: 0.85rem; color: var(--text-muted); margin-top:-5px; margin-bottom: 15px;">Fields matching your natural aptitudes.</p>
                        <div id="reportCareersContainer"></div>
                        
                        <h3 style="margin-top: 30px; border-top: 1px solid var(--border); padding-top: 20px;">üö´ Vulnerability Zones</h3>
                        <p style="font-size: 0.85rem; color: #475569; margin-top:-5px; margin-bottom: 10px;">Careers leading to higher burnout probability.</p>
                        <p id="reportAvoid" style="color: var(--danger); font-weight: bold; font-size: 0.95rem;"></p>
                    </div>
                </div>
                
                <div class="card">
                    <h3>üìÖ 1-Year Execution Action Plan</h3>
                    <div class="grid-2">
                        <div style="background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid transparent;">
                            <h4 style="color: var(--primary); margin-top: 0;">üìö Recommended Courses</h4>
                            <ul id="reportPlanCourses" style="color: #334155; line-height: 1.6; font-size: 0.9rem;"></ul>
                        </div>
                        <div style="background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid transparent;">
                            <h4 style="color: var(--primary); margin-top: 0;">üéØ Exams & Focus</h4>
                            <ul id="reportPlanExams" style="color: #334155; line-height: 1.6; font-size: 0.9rem;"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-portfolio" class="tab-content">
            <div class="header-bar">
                <div><h1>Academic Profile</h1><p>Provide your context to enhance AI targeting.</p></div>
            </div>
            
            <div class="step-indicator">
                <span class="step-pill active">Step 1: Metrics & Subjects</span>
                <span class="step-pill">Step 2: School Context</span>
            </div>

            <div class="grid-2">
                <div class="card" id="academicInputCard" style="border-top: 4px solid var(--primary);">
                    <h3>üìä Core Academic Metrics</h3>
                    
                    <div class="grid-2col" style="gap:15px;">
                        <div class="form-group">
                            <label class="form-label">Grading System</label>
                            <select id="portGradingSystem" class="form-select" onchange="updateGradingInput()">
                                <option value="Percentage (%)">Percentage (%)</option>
                                <option value="GPA (Out of 4)">GPA (Out of 4)</option>
                                <option value="CGPA (Out of 10)">CGPA (Out of 10)</option>
                                <option value="Percentile">Percentile</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Overall Score</label>
                            <input type="number" id="portOverallScore" class="form-input" placeholder="e.g. 88" step="0.01" min="0" max="100">
                        </div>
                    </div>

                    <div class="grid-2col" style="gap:15px; margin-bottom: 25px;">
                        <div class="form-group">
                            <label class="form-label">Academic Trend</label>
                            <select id="portTrend" class="form-select">
                                <option value="Stable">Stable</option>
                                <option value="Improving">Improving</option>
                                <option value="Declining">Declining</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Target Stream</label>
                            <select id="portStream" class="form-select">
                                <option value="Undecided">Undecided</option>
                                <option value="PCM">PCM</option>
                                <option value="PCB">PCB</option>
                                <option value="Commerce">Commerce</option>
                                <option value="Arts">Arts</option>
                            </select>
                        </div>
                    </div>

                    <div style="border-top: 1px solid var(--border); padding-top: 25px; margin-top:10px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <h3 style="border:none; padding:0; margin:0;">üìò Subject Breakdowns</h3>
                            <button type="button" class="btn btn-outline" onclick="toggleSubjectSection()" id="toggleSubjectBtn" style="padding: 6px 12px; font-size: 0.8rem;">View / Add Subjects ‚¨á</button>
                        </div>
                        
                        <div id="subjectSectionWrapper" style="display:none;">
                            <div id="subjectContainer">
                                </div>
                            <button type="button" class="btn btn-outline" onclick="addSubjectRow()" style="margin-bottom: 10px; font-size: 0.85rem; padding: 8px 15px; width:100%;">‚ûï Add Another Subject</button>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="card" style="border-top: 4px solid #8b5cf6; margin-bottom: 20px;">
                        <h3>üéì School Context</h3>
                        <div class="form-group">
                            <label class="form-label">School Name</label>
                            <input type="text" id="portSchoolName" class="form-input" placeholder="Enter full school name">
                        </div>
                        <div class="grid-2col" style="gap:15px;">
                            <div class="form-group">
                                <label class="form-label">Board of Studies</label>
                                <select id="portBoard" class="form-select">
                                    <option value="CBSE">CBSE</option>
                                    <option value="ICSE">ICSE / ISC</option>
                                    <option value="State Board">State Board</option>
                                    <option value="IB">IB</option>
                                    <option value="Cambridge (IGCSE)">Cambridge (IGCSE/A-Level)</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Country</label>
                                <select id="portCountry" class="form-select" onchange="toggleLocationFields()">
                                    <option value="India">India</option>
                                    <option value="NRI/International">NRI / International</option>
                                </select>
                            </div>
                        </div>

                        <div id="indianLocationFields" class="grid-2col" style="gap:15px;">
                            <div class="form-group">
                                <label class="form-label">State</label>
                                <select id="portState" class="form-select" onchange="populateDistricts()">
                                    <option value="">Select State</option>
                                    </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">District</label>
                                <select id="portDistrict" class="form-select">
                                    <option value="">Select District</option>
                                    </select>
                            </div>
                        </div>
                    </div>

                    <div class="card" style="border-top: 4px solid var(--accent); margin-bottom: 20px;">
                        <h3>üèÜ Extra-Curriculars</h3>
                        <textarea class="form-textarea" rows="3" placeholder="e.g. 1st Place State Science Fair..." id="portExtraCurricular"></textarea>
                    </div>
                    
                    <button class="btn hide-from-parent" style="width:100%; padding: 16px; font-size: 1.1rem; box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);" onclick="saveAcademicPortfolio()">üíæ Save Academic Profile</button>
                </div>
            </div>
        </div>

        <div id="tab-counselling" class="tab-content">
            <div class="header-bar"><h1>Book Expert Session</h1><p>Get 1-on-1 clarity with a certified professional.</p></div>
            <div class="grid-3-1">
                <div class="card">
                    <h3 style="margin-bottom: 20px;">Secure Your Slot</h3>
                    <div class="form-group">
                        <label class="form-label">Select Expert Counsellor</label>
                        <select class="form-select" id="bookCounsellorSelect" onchange="showCounsellorTimes(this.value)"><option value="">-- Loading Experts --</option></select>
                    </div>
                    
                    <div id="bookingAvailInfo" style="margin-bottom: 25px; padding: 20px; background: #f8fafc; border: 1px solid var(--border); border-radius: 12px; display:none;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;"><span style="color:#64748b; font-weight:bold; font-size:0.8rem; text-transform:uppercase;">Availability</span><span id="bookingTimeText" style="color:#0f172a; font-weight:800;">Mon, Wed, Fri</span></div>
                        <div style="display:flex; justify-content:space-between; border-top: 1px dashed var(--border); padding-top:10px; margin-top:10px;"><span style="color:#64748b; font-weight:bold; font-size:0.8rem; text-transform:uppercase;">Consultation Fee</span><span style="color:var(--success); font-weight:800; font-size:1rem;">100% Free</span></div>
                        
                        <div style="border-top: 1px solid var(--border); margin-top: 15px; padding-top: 15px;">
                            <div class="grid-2col" style="margin-bottom: 15px;">
                                <div class="form-group" style="margin:0;">
                                    <label class="form-label">Select Date</label>
                                    <input type="date" id="bookDate" class="form-input" required>
                                </div>
                                <div class="form-group" style="margin:0;">
                                    <label class="form-label">Select Time</label>
                                    <input type="time" id="bookTime" class="form-input" required>
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label class="form-label">Contact Number</label>
                                <input type="tel" id="bookPhone" class="form-input" placeholder="+91 99999 99999" required>
                            </div>
                            <div class="form-group" style="margin:0;">
                                <label class="form-label">Preferred Medium</label>
                                <select id="bookMedium" class="form-select">
                                    <option value="Google Meet">Google Meet (Video)</option>
                                    <option value="Phone Call">Direct Phone Call</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn hide-from-parent" id="confirmBookingBtn" onclick="submitBooking()" style="width:100%; padding: 14px;">Confirm Booking</button>
                </div>
            </div>
        </div>

        <div id="tab-chat" class="tab-content">
            <div class="header-bar">
                <div>
                    <h1>Direct Chat</h1>
                    <p>Secure messaging with your assigned expert.</p>
                </div>
            </div>
            <div class="grid-3-1">
                <div class="card" style="padding:0; overflow:hidden; display:flex; flex-direction:column; height:60vh;">
                    <div style="padding: 20px 25px; border-bottom: 1px solid var(--border); background: #f8fafc;">
                        <div class="form-group" style="margin:0;">
                            <label class="form-label" style="font-size:0.75rem;">Select Counsellor</label>
                            <select class="form-select" id="studentChatSelect" onchange="loadCounsellorChat(this.value)"><option value="">-- Choose a Counsellor --</option></select>
                        </div>
                    </div>
                    <div style="flex:1; padding: 25px; overflow-y:auto; background: #ffffff;" id="studentChatMessages">
                        <div style="text-align:center; color:var(--text-muted); margin-top:40px; font-size: 1rem;">Select a counsellor to start chatting.</div>
                    </div>
                    <div style="padding: 20px 25px; border-top: 1px solid var(--border); display:flex; gap:15px; background: #f8fafc;">
                        <input type="text" id="studentChatInput" class="form-input" placeholder="Type a message..." style="margin:0; background:white;">
                        <button class="btn" onclick="sendStudentChatMessage()" style="padding: 0 25px;">Send</button>
                    </div>
                </div>
                <div>
                    <div class="card">
                        <h3>Expert Profile</h3>
                        <div id="counsellorProfileCard" style="text-align:center; color:var(--text-muted); padding: 20px 0; font-size:0.9rem;">Select a counsellor to view profile.</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-settings" class="tab-content">
            <div class="header-bar"><h1>Profile Settings</h1><p>Manage your account details and preferences.</p></div>
            <div class="card">
                <div class="grid-2col" style="margin-bottom: 25px;">
                    <div class="form-group"><label class="form-label">Full Name</label><input type="text" id="setStuName" class="form-input" readonly style="background: #f1f5f9;"></div>
                    <div class="form-group"><label class="form-label">Registered Email</label><input type="text" id="setStuEmail" class="form-input" readonly style="background: #f1f5f9;"></div>
                </div>
                <div class="grid-2col">
                    <div class="form-group"><label class="form-label">Parent Name</label><input type="text" class="form-input" placeholder="Enter parent's name"></div>
                    <div class="form-group"><label class="form-label">Parent Phone</label><input type="text" class="form-input" placeholder="+91 XXXXX XXXXX"></div>
                </div>
                <button class="btn hide-from-parent" style="margin-top:20px;">üíæ Save Details</button>
            </div>
        </div>

    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, collection, getDocs, updateDoc, addDoc, serverTimestamp, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

    // ‚ö†Ô∏è REPLACE WITH YOUR ACTUAL CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyBygHYMOSuKueZf9nE5LmSwCyCeZ2dNeD0",
      authDomain: "career-intelligence-system.firebaseapp.com",
      projectId: "career-intelligence-system",
      storageBucket: "career-intelligence-system.firebasestorage.app",
      messagingSenderId: "223785446772",
      appId: "1:223785446772:web:0f9ded4e89a978fc551021"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    let activeUserUid = null;
    let studentDataObj = null;
    let miniChartInstance = null;
    let unsubscribeChat = null; 
    let globalUnreadCount = 0;
    const activeChatListeners = []; 
    let previouslyUnlockedBadges = new Set();

    // --- FULL INDIAN STATES & DISTRICTS ---
    const stateDistricts = {
      "Andaman and Nicobar Islands": ["Nicobar", "North and Middle Andaman", "South Andaman"],
      "Andhra Pradesh": ["Adilabad", "Anantapur", "Chittoor", "East Godavari", "Guntur", "Hyderabad", "Kadapa", "Krishna", "Kurnool", "Nellore", "Prakasam", "Srikakulam", "Visakhapatnam", "Vizianagaram", "West Godavari"],
      "Arunachal Pradesh": ["Anjaw", "Changlang", "East Kameng", "East Siang", "Kurung Kumey", "Lohit", "Lower Dibang Valley", "Lower Subansiri", "Papum Pare", "Tawang", "Tirap", "Upper Dibang Valley", "Upper Siang", "Upper Subansiri", "West Kameng", "West Siang"],
      "Assam": ["Baksa", "Barpeta", "Bongaigaon", "Cachar", "Charaideo", "Chirang", "Darrang", "Dhemaji", "Dhubri", "Dibrugarh", "Dima Hasao", "Goalpara", "Golaghat", "Hailakandi", "Jorhat", "Kamrup Metropolitan", "Kamrup", "Karbi Anglong", "Karimganj", "Kokrajhar", "Lakhimpur", "Morigaon", "Nagaon", "Nalbari", "Sivasagar", "Sonitpur", "Tinsukia", "Udalguri"],
      "Bihar": ["Baksa", "Barpeta", "Bongaigaon", "Cachar", "Charaideo", "Chirang", "Darrang", "Dhemaji", "Dhubri", "Dibrugarh", "Dima Hasao", "Goalpara", "Golaghat", "Hailakandi", "Jorhat", "Kamrup Metropolitan", "Kamrup", "Karbi Anglong", "Karimganj", "Kokrajhar", "Lakhimpur", "Morigaon", "Nagaon", "Nalbari", "Sivasagar", "Sonitpur", "Tinsukia", "Udalguri"],
      "Chandigarh": ["Chandigarh"],
      "Chhattisgarh": ["Adilabad", "Bhadradri Kothagudem", "Hyderabad", "Jagtial", "Jangaon", "Jayashankar Bhupalpally", "Jogulamba Gadwal", "Kamareddy", "Karimnagar", "Khammam", "Komaram Bheem Asifabad", "Mahabubabad", "Mahabubnagar", "Mancherial", "Medak", "Medchal", "Nagarkurnool", "Nalgonda", "Nirmal", "Nizamabad", "Peddapalli", "Rajanna Sircilla", "Ranga Reddy", "Sangareddy", "Siddipet", "Suryapet", "Vikarabad", "Wanaparthy", "Warangal (Rural)", "Warangal (Urban)", "Yadadri Bhuvanagiri"],
      "Dadra and Nagar Haveli": ["Dadra and Nagar Haveli"],
      "Daman and Diu": ["Daman", "Diu"],
      "Delhi": ["Central Delhi", "East Delhi", "New Delhi", "North Delhi", "North East Delhi", "North West Delhi", "Shahdara", "South Delhi", "South East Delhi", "South West Delhi", "West Delhi"],
      "Goa": ["North Goa", "South Goa"],
      "Gujarat": ["North Goa", "South Goa"],
      "Haryana": ["Ambala", "Bhiwani", "Charkhi Dadri", "Faridabad", "Fatehabad", "Gurugram", "Hisar", "Jhajjar", "Jind", "Kaithal", "Karnal", "Kurukshetra", "Mahendragarh", "Mewat", "Palwal", "Panchkula", "Panipat", "Rewari", "Rohtak", "Sirsa", "Sonipat", "Yamunanagar"],
      "Himachal Pradesh": ["Bilaspur", "Chamba", "Hamirpur", "Kangra", "Kinnaur", "Kullu", "Lahaul and Spiti", "Mandi", "Shimla", "Sirmaur", "Solan", "Una"],
      "Jammu and Kashmir": ["Anantnag", "Bandipore", "Baramulla", "Budgam", "Doda", "Ganderbal", "Jammu", "Kargil", "Kathua", "Kishtwar", "Kulgam", "Kupwara", "Poonch", "Pulwama", "Rajouri", "Ramban", "Reasi", "Samba", "Shopian", "Srinagar", "Udhampur"],
      "Jharkhand": ["Araria", "Arwal", "Aurangabad", "Banka", "Begusarai", "Bhagalpur", "Bhojpur", "Buxar", "Darbhanga", "East Champaran", "Gaya", "Gopalganj", "Jamui", "Jehanabad", "Kaimur", "Katihar", "Khagaria", "Kishanganj", "Lakhisarai", "Madhepura", "Madhubani", "Munger", "Muzaffarpur", "Nalanda", "Nawada", "Patna", "Purnia", "Rohtas", "Saharsa", "Samastipur", "Saran", "Sheikhpura", "Sheohar", "Sitamarhi", "Siwan", "Supaul", "Vaishali", "West Champaran"],
      "Karnataka": ["Bagalkot", "Ballari (Bellary)", "Belagavi (Belgaum)", "Bengaluru (Bangalore) Rural", "Bengaluru (Bangalore) Urban", "Bidar", "Chamarajanagar", "Chikballapur", "Chikkamagaluru", "Chitradurga", "Dakshina Kannada", "Davangere", "Dharwad", "Gadag", "Hassan", "Haveri", "Kalaburagi (Gulbarga)", "Kodagu", "Kolar", "Koppal", "Mandya", "Mysuru (Mysore)", "Raichur", "Ramanagara", "Shivamogga (Shimoga)", "Tumakuru (Tumkur)", "Udupi", "Uttara Kannada (Karwar)", "Vijayapura (Bijapur)", "Yadgir"],
      "Kerala": ["Alappuzha", "Ernakulam", "Idukki", "Kannur", "Kasaragod", "Kollam", "Kottayam", "Kozhikode", "Malappuram", "Palakkad", "Pathanamthitta", "Thiruvananthapuram", "Thrissur", "Wayanad"],
      "Lakshadweep": ["Lakshadweep"],
      "Madhya Pradesh": ["Agar Malwa", "Alirajpur", "Anuppur", "Ashoknagar", "Balaghat", "Barwani", "Betul", "Bhind", "Bhopal", "Burhanpur", "Chhatarpur", "Chhindwara", "Damoh", "Datia", "Dewas", "Dhar", "Dindori", "Guna", "Gwalior", "Harda", "Hoshangabad", "Indore", "Jabalpur", "Jhabua", "Katni", "Khandwa", "Khargone", "Mandla", "Mandsaur", "Morena", "Narsinghpur", "Neemuch", "Panna", "Raisen", "Rajgarh", "Ratlam", "Rewa", "Sagar", "Satna", "Sehore", "Seoni", "Shahdol", "Shajapur", "Sheopur", "Shivpuri", "Sidhi", "Singrauli", "Tikamgarh", "Ujjain", "Umaria", "Vidisha"],
      "Maharashtra": ["Ahmednagar", "Akola", "Amravati", "Aurangabad", "Beed", "Bhandara", "Buldhana", "Chandrapur", "Dhule", "Gadchiroli", "Gondia", "Hingoli", "Jalgaon", "Jalna", "Kolhapur", "Latur", "Mumbai City", "Mumbai Suburban", "Nagpur", "Nanded", "Nandurbar", "Nashik", "Osmanabad", "Palghar", "Parbhani", "Pune", "Raigad", "Ratnagiri", "Sangli", "Satara", "Sindhudurg", "Solapur", "Thane", "Wardha", "Washim", "Yavatmal"],
      "Manipur": ["Anjaw", "Changlang", "East Kameng", "East Siang", "Kurung Kumey", "Lohit", "Lower Dibang Valley", "Lower Subansiri", "Papum Pare", "Tawang", "Tirap", "Upper Dibang Valley", "Upper Siang", "Upper Subansiri", "West Kameng", "West Siang"],
      "Meghalaya": ["Bishnupur", "Chandel", "Churachandpur", "Imphal East", "Imphal West", "Jiribam", "Kakching", "Kamjong", "Kangpokpi", "Noney", "Pherzawl", "Senapati", "Tamenglong", "Tengnoupal", "Thoubal", "Ukhrul"],
      "Mizoram": ["East Garo Hills", "East Jaintia Hills", "East Khasi Hills", "North Garo Hills", "Ri Bhoi", "South Garo Hills", "South West Garo Hills", "South West Khasi Hills", "West Garo Hills", "West Jaintia Hills", "West Khasi Hills"],
      "Nagaland": ["Dimapur", "Kiphire", "Kohima", "Longleng", "Mokokchung", "Mon", "Peren", "Phek", "Tuensang", "Wokha", "Zunheboto"],
      "Odisha": ["Angul", "Balangir", "Balasore", "Bargarh", "Bhadrak", "Boudh", "Cuttack", "Deogarh", "Dhenkanal", "Gajapati", "Ganjam", "Jagatsinghapur", "Jajpur", "Jharsuguda", "Kalahandi", "Kandhamal", "Kendrapara", "Kendujhar (Keonjhar)", "Khordha", "Koraput", "Malkangiri", "Mayurbhanj", "Nabarangpur", "Nayagarh", "Nuapada", "Puri", "Rayagada", "Sambalpur", "Subarnapur", "Sundargarh"],
      "Puducherry": ["Karaikal", "Mahe", "Pondicherry", "Yanam"],
      "Punjab": ["Amritsar", "Barnala", "Bathinda", "Faridkot", "Fatehgarh Sahib", "Fazilka", "Ferozepur", "Gurdaspur", "Hoshiarpur", "Jalandhar", "Kapurthala", "Ludhiana", "Mansa", "Moga", "Muktsar", "Nawanshahr (Shahid Bhagat Singh Nagar)", "Pathankot", "Patiala", "Rupnagar", "Sahibzada Ajit Singh Nagar (Nawanshahr)", "Sangrur", "Tarn Taran"],
      "Rajasthan": ["Ahmedabad", "Amreli", "Anand", "Aravalli", "Banaskantha (Palanpur)", "Bharuch", "Bhavnagar", "Botad", "Chhota Udepur", "Dahod", "Dangs (Ahwa)", "Devbhoomi Dwarka", "Gandhinagar", "Gir Somnath", "Jamnagar", "Junagadh", "Kachchh", "Kheda (Nadiad)", "Mahisagar", "Mehsana", "Morbi", "Narmada (Rajpipla)", "Navsari", "Panchmahal (Godhra)", "Patan", "Porbandar", "Rajkot", "Sabarkantha (Himmatnagar)", "Surat", "Surendranagar", "Tapi (Vyara)", "Vadodara", "Valsad"],
      "Sikkim": ["Dimapur", "Kiphire", "Kohima", "Longleng", "Mokokchung", "Mon", "Peren", "Phek", "Tuensang", "Wokha", "Zunheboto"],
      "Tamil Nadu": ["Ariyalur", "Chennai", "Coimbatore", "Cuddalore", "Dharmapuri", "Dindigul", "Erode", "Kanchipuram", "Kanyakumari", "Karur", "Krishnagiri", "Madurai", "Nagapattinam", "Namakkal", "Nilgiris", "Perambalur", "Pudukkottai", "Ramanathapuram", "Salem", "Sivaganga", "Thanjavur", "Theni", "Thoothukudi (Tuticorin)", "Tiruchirappalli", "Tirunelveli", "Tiruppur", "Tiruvallur", "Tiruvannamalai", "Tiruvarur", "Vellore", "Viluppuram", "Virudhunagar"],
      "Telangana": ["Adilabad", "Bhadradri Kothagudem", "Hyderabad", "Jagtial", "Jangaon", "Jayashankar Bhupalpally", "Jogulamba Gadwal", "Kamareddy", "Karimnagar", "Khammam", "Komaram Bheem Asifabad", "Mahabubabad", "Mahabubnagar", "Mancherial", "Medak", "Medchal", "Nagarkurnool", "Nalgonda", "Nirmal", "Nizamabad", "Peddapalli", "Rajanna Sircilla", "Ranga Reddy", "Sangareddy", "Siddipet", "Suryapet", "Vikarabad", "Wanaparthy", "Warangal (Rural)", "Warangal (Urban)", "Yadadri Bhuvanagiri"],
      "Tripura": ["Aizawl", "Champhai", "Kolasib", "Lawngtlai", "Lunglei", "Mamit", "Saiha", "Serchhip"],
      "Uttar Pradesh": ["Ajmer", "Alwar", "Banswara", "Baran", "Barmer", "Barmer", "Bhilwara", "Bikaner", "Bundi", "Chittorgarh", "Churu", "Dausa", "Dholpur", "Dungarpur", "Hanumangarh", "Jaipur", "Jaisalmer", "Jalore", "Jhalawar", "Jhunjhunu", "Jodhpur", "Karauli", "Kota", "Nagaur", "Pali", "Pratapgarh", "Rajsamand", "Sawai Madhopur", "Sikar", "Sirohi", "Sri Ganganagar", "Tonk", "Udaipur"],
      "Uttarakhand": ["Almora", "Bageshwar", "Chamoli", "Champawat", "Dehradun", "Haridwar", "Nainital", "Pauri Garhwal", "Pithoragarh", "Rudraprayag", "Tehri Garhwal", "Udham Singh Nagar", "Uttarkashi"],
      "West Bengal": ["Alipurduar", "Bankura", "Birbhum", "Burdwan (Bardhaman)", "Cooch Behar", "Dakshin Dinajpur (South Dinajpur)", "Darjeeling", "Hooghly", "Howrah", "Jalpaiguri", "Kalimpong", "Kolkata", "Malda", "Murshidabad", "Nadia", "North 24 Parganas", "Paschim Medinipur (West Medinipur)", "Purba Medinipur (East Medinipur)", "Purulia", "South 24 Parganas", "Uttar Dinajpur (North Dinajpur)"]
    };

    window.populateStates = function() {
        const stateSelect = document.getElementById('portState');
        stateSelect.innerHTML = '<option value="">Select State</option>';
        Object.keys(stateDistricts).sort().forEach(state => {
            stateSelect.innerHTML += `<option value="${state}">${state}</option>`;
        });
    }

    window.populateDistricts = function(selectedDistrict = "") {
        const stateSelect = document.getElementById('portState').value;
        const distSelect = document.getElementById('portDistrict');
        distSelect.innerHTML = '<option value="">Select District</option>';
        
        if(stateSelect && stateDistricts[stateSelect]) {
            stateDistricts[stateSelect].sort().forEach(dist => {
                distSelect.innerHTML += `<option value="${dist}" ${dist === selectedDistrict ? 'selected' : ''}>${dist}</option>`;
            });
        }
    }

    window.toggleLocationFields = function() {
        const country = document.getElementById('portCountry').value;
        const locWrap = document.getElementById('indianLocationFields');
        if(country === 'India') {
            locWrap.style.display = 'grid';
        } else {
            locWrap.style.display = 'none';
            document.getElementById('portState').value = "";
            document.getElementById('portDistrict').value = "";
        }
    }

    window.updateGradingInput = function() {
        const sys = document.getElementById('portGradingSystem').value;
        const inp = document.getElementById('portOverallScore');
        if(sys.includes('%') || sys === 'Percentile') { inp.placeholder = 'e.g. 88'; inp.max = 100; }
        else if(sys.includes('4')) { inp.placeholder = 'e.g. 3.8'; inp.max = 4; }
        else if(sys.includes('10')) { inp.placeholder = 'e.g. 9.2'; inp.max = 10; }
    }
    
    window.toggleSubjectSection = function() {
        const wrap = document.getElementById('subjectSectionWrapper');
        const btn = document.getElementById('toggleSubjectBtn');
        if(wrap.style.display === 'none') {
            wrap.style.display = 'block';
            btn.innerText = 'Hide Subjects ‚¨Ü';
        } else {
            wrap.style.display = 'none';
            btn.innerText = 'View / Add Subjects ‚¨á';
        }
    }

    window.addSubjectRow = function(name = "", score = "", grade = "") {
        const container = document.getElementById('subjectContainer');
        const row = document.createElement('div');
        row.className = 'subject-row';
        row.innerHTML = `
            <div class="form-group">
                <label class="form-label" style="${container.children.length > 0 ? 'display:none;' : ''}">Subject Name</label>
                <input type="text" class="form-input sub-name" placeholder="e.g. Physics" value="${name}">
            </div>
            <div class="form-group">
                <label class="form-label" style="${container.children.length > 0 ? 'display:none;' : ''}">Score/Marks</label>
                <input type="number" class="form-input sub-score" placeholder="e.g. 85" step="0.01" value="${score}">
            </div>
            <div class="form-group">
                <label class="form-label" style="${container.children.length > 0 ? 'display:none;' : ''}">Grade (Opt)</label>
                <input type="text" class="form-input sub-grade" placeholder="e.g. A+" value="${grade}">
            </div>
            <button type="button" class="btn-remove-sub" onclick="this.parentElement.remove()" style="${container.children.length > 0 ? 'margin-top:0;' : ''}" title="Remove Subject">√ó</button>
        `;
        container.appendChild(row);
    }
    
    // Initialize standard state dropdown on load
    populateStates();

    // Disallow past dates in calendar
    const today = new Date().toISOString().split('T')[0];
    document.getElementById("bookDate").setAttribute('min', today);

    window.launchAssessment = function() {
        const currentUrl = window.location.href;
        const basePath = currentUrl.substring(0, currentUrl.lastIndexOf('/'));
        window.location.href = basePath + "/assessment/";
    };

    window.switchTab = function(tabId, btn) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        btn.classList.add('active');
        document.getElementById('headerTitle').innerText = btn.innerText.replace(/[^\w\s]/gi, '').trim();
        
        if(tabId === 'tab-chat') {
            globalUnreadCount = 0;
            const badge = document.getElementById('notifBadge');
            badge.style.display = 'none';
            badge.innerText = '0';
        }
    };

    window.toggleMilestones = function() {
        const section = document.getElementById('milestoneSection');
        const btn = document.getElementById('milestoneToggleBtn');
        if (section.classList.contains('expanded')) {
            section.classList.remove('expanded');
            btn.innerText = "View My Progress ‚¨á";
        } else {
            section.classList.add('expanded');
            btn.innerText = "Hide Progress ‚¨Ü";
        }
    }

    // --- TOAST NOTIFICATION SYSTEM ---
    window.showToastNotification = function(title, message) {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.innerHTML = `<div class="toast-title">üîî ${title}</div><div class="toast-body">${message}</div>`;
        
        toast.onclick = () => {
            if(title.includes("Achievement") || title.includes("Level") || title.includes("Academic")) {
                window.switchTab('tab-home', document.querySelectorAll('.nav-btn')[0]);
            } else {
                window.switchTab('tab-chat', document.querySelectorAll('.nav-btn')[5]);
            }
            toast.style.animation = 'fadeOut 0.3s ease forwards';
            setTimeout(() => toast.remove(), 300);
        };

        container.appendChild(toast);
        setTimeout(() => {
            if(toast.parentElement) {
                toast.style.animation = 'fadeOut 0.3s ease forwards';
                setTimeout(() => toast.remove(), 300);
            }
        }, 5000);
    }

    window.toggleParentMode = function() {
        const btn = document.getElementById('parentToggleBtn');
        const icon = document.getElementById('parentToggleIcon');
        const text = document.getElementById('parentToggleText');
        
        if(!document.body.classList.contains('parent-mode-active')) {
            document.body.classList.add('parent-mode-active');
            btn.classList.add('active');
            icon.innerText = "üîê";
            text.innerText = "Exit Parent View";
            const activeTab = document.querySelector('.tab-content.active').id;
            if(activeTab === 'tab-chat' || activeTab === 'tab-settings' || activeTab === 'tab-counselling') {
                window.switchTab('tab-home', document.querySelectorAll('.nav-btn')[0]);
            }
        } else {
            document.body.classList.remove('parent-mode-active');
            btn.classList.remove('active');
            icon.innerText = "üë®‚Äçüë©‚Äçüëß";
            text.innerText = "Parent View";
        }
    }

    function renderCareerLabActuals(report) {
        if(!report || !report.topCareers || report.topCareers.length === 0) return;
        let labHtml = `<div style="margin-bottom: 20px;"><h3 style="color:var(--primary); margin-top:0;">Based on your Psychometric Data:</h3><p style="color:var(--text-muted); margin-top:-5px;">Here are your customized subject combinations and college targets.</p></div>`;

        report.topCareers.slice(0,3).forEach(c => {
            let subjects = "Check specific college criteria.";
            let searchString = c.name; 
            
            if(c.name.toLowerCase().includes('engineer') || c.name.toLowerCase().includes('tech') || c.name.toLowerCase().includes('data')) { subjects = "Physics, Chemistry, Mathematics (PCM) + Computer Science"; searchString = "engineering"; }
            else if(c.name.toLowerCase().includes('medic') || c.name.toLowerCase().includes('doctor') || c.name.toLowerCase().includes('clinic')) { subjects = "Physics, Chemistry, Biology (PCB)"; searchString = "medical"; }
            else if(c.name.toLowerCase().includes('business') || c.name.toLowerCase().includes('financ') || c.name.toLowerCase().includes('account')) { subjects = "Commerce, Accountancy, Economics, Business Studies"; searchString = "commerce"; }
            else if(c.name.toLowerCase().includes('design') || c.name.toLowerCase().includes('art') || c.name.toLowerCase().includes('media')) { subjects = "Any Stream (Focus heavily on Portfolio & Creativity)"; searchString = "design"; }
            else if(c.name.toLowerCase().includes('law') || c.name.toLowerCase().includes('policy')) { subjects = "Any Stream (Humanities or Commerce preferred) + Legal Studies"; searchString = "law"; }

            labHtml += `
            <div class="card" style="border-left: 4px solid var(--primary); margin-bottom: 15px; padding: 25px;">
                <h4 style="margin: 0 0 10px 0; font-size: 1.15rem; color: #0f172a;">${c.name} <span class="status-pill status-success" style="float:right;">${c.score}% Match</span></h4>
                <p style="margin: 0 0 15px 0; font-size: 0.9rem; color: var(--text-muted);"><strong>Recommended Subjects:</strong> ${subjects}</p>
                <a href="https://antoniovn96.github.io/vidyavantage.github.io/colleges/?search=${searchString}" target="_blank" class="btn btn-outline" style="padding: 10px 20px; font-size: 0.85rem; text-decoration: none; display: inline-block;">üè´ View Best Colleges ‚ûî</a>
            </div>`;
        });
        document.getElementById('exploreLabDynamicArea').innerHTML = labHtml;
    }

    window.showCounsellorTimes = function(cid) {
        const infoBox = document.getElementById('bookingAvailInfo');
        if(cid) { infoBox.style.display = 'block'; } else { infoBox.style.display = 'none'; }
    }

    window.submitBooking = async function() {
        const cid = document.getElementById('bookCounsellorSelect').value;
        const date = document.getElementById('bookDate').value;
        const time = document.getElementById('bookTime').value;
        const phone = document.getElementById('bookPhone').value;
        const medium = document.getElementById('bookMedium').value;

        if(!cid || !date || !time || !phone) return alert("Please complete all booking fields.");

        const btn = document.getElementById('confirmBookingBtn');
        btn.innerText = "Processing Booking... ‚è≥";
        btn.disabled = true;

        try {
            await addDoc(collection(db, "bookings"), {
                studentId: activeUserUid,
                studentName: studentDataObj.name,
                studentEmail: studentDataObj.email,
                counsellorId: cid,
                counsellorName: window.globalCounsellors[cid].name,
                date: date, time: time, phone: phone, medium: medium,
                status: "Pending", timestamp: serverTimestamp()
            });

            const currentSessions = studentDataObj.sessionsHad || 0;
            await updateDoc(doc(db, "students", activeUserUid), { sessionsHad: currentSessions + 1 });
            studentDataObj.sessionsHad = currentSessions + 1;
            calculateDynamicScore(studentDataObj);

            showToastNotification("Booking Confirmed! üéâ", `Your session on ${date} at ${time} is locked.`);
            document.getElementById('bookDate').value = ""; document.getElementById('bookTime').value = ""; document.getElementById('bookPhone').value = ""; document.getElementById('bookCounsellorSelect').value = ""; showCounsellorTimes(""); 
        } catch (e) { console.error(e); alert("Error connecting to the scheduling system."); } finally { btn.innerText = "Confirm Booking"; btn.disabled = false; }
    }

    async function loadCounsellors() {
        const chatSelect = document.getElementById('studentChatSelect');
        const bookSelect = document.getElementById('bookCounsellorSelect');
        window.globalCounsellors = {};
        try {
            const snap = await getDocs(collection(db, "counsellor_profiles"));
            if(!snap.empty) {
                chatSelect.innerHTML = '<option value="">-- Choose your assigned Counsellor --</option>';
                bookSelect.innerHTML = '<option value="">-- Choose an Expert --</option>';
                activeChatListeners.forEach(unsub => unsub()); activeChatListeners.length = 0;

                snap.forEach(docSnap => {
                    const data = docSnap.data();
                    window.globalCounsellors[docSnap.id] = data;
                    const optionHtml = `<option value="${docSnap.id}">üü¢ ${data.name || docSnap.id} - Online</option>`;
                    chatSelect.innerHTML += optionHtml; bookSelect.innerHTML += optionHtml;

                    const chatId = `${activeUserUid}_${docSnap.id}`;
                    const q = query(collection(db, "chats", chatId, "messages"), orderBy("timestamp", "asc"));
                    let isInitialLoad = true;

                    const unsub = onSnapshot(q, (snapshot) => {
                        snapshot.docChanges().forEach((change) => {
                            if (change.type === "added") {
                                const msg = change.doc.data();
                                if (!isInitialLoad && msg.senderId !== activeUserUid) {
                                    const isViewingChat = document.querySelector('.tab-content.active').id === 'tab-chat' && document.getElementById('studentChatSelect').value === docSnap.id;
                                    if(!isViewingChat) {
                                        globalUnreadCount++;
                                        const badge = document.getElementById('notifBadge');
                                        badge.innerText = globalUnreadCount; badge.style.display = 'flex';
                                        showToastNotification(data.name || "Counsellor", "Sent you a new message.");
                                    }
                                }
                            }
                        });
                        isInitialLoad = false;
                    });
                    activeChatListeners.push(unsub);
                });
            } else { chatSelect.innerHTML = '<option value="">No counsellors registered.</option>'; bookSelect.innerHTML = '<option value="">No experts registered.</option>'; }
        } catch(e) { console.error("Error loading counsellors:", e); }
    }

    window.loadCounsellorChat = function(counsellorId) {
        if(!counsellorId) { document.getElementById('counsellorProfileCard').innerHTML = "Select a counsellor to view profile."; return; }
        const c = window.globalCounsellors[counsellorId];
        if(c) {
            document.getElementById('counsellorProfileCard').innerHTML = `
                <img src="${c.photo || 'https://ui-avatars.com/api/?name=Expert&background=3b82f6&color=fff'}" style="width:90px; height:90px; border-radius:50%; object-fit:cover; border:3px solid var(--success); margin-bottom:15px;">
                <h4 style="margin:0; color:#0f172a; font-size:1.1rem;">${c.name}</h4>
                <p style="font-size:0.8rem; margin:5px 0; color:var(--success); font-weight:bold;">üü¢ Online Now</p>
                <p style="font-size:0.85rem; line-height:1.5;">${c.bio || 'Clinical Career Expert'}</p>
            `;
        }

        if(unsubscribeChat) unsubscribeChat();
        const chatBox = document.getElementById('studentChatMessages');
        chatBox.innerHTML = '<div style="text-align:center; color:var(--text-muted); margin-top:40px;">Loading messages...</div>';

        const chatId = `${activeUserUid}_${counsellorId}`;
        const q = query(collection(db, "chats", chatId, "messages"), orderBy("timestamp", "asc"));

        unsubscribeChat = onSnapshot(q, (snapshot) => {
            let html = '<div style="text-align:center; color:var(--text-muted); margin-bottom: 25px; font-size:0.8rem; padding: 5px 15px; background: #f1f5f9; border-radius: 50px; display:inline-block; margin-left: 50%; transform: translateX(-50%);">üîí Secure connection established.</div>';
            if(snapshot.empty) { html += `<div class="chat-message chat-counsellor">Hi! I am your career expert. Send a message to start our session.</div>`; } 
            else {
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const isStudent = msg.senderId === activeUserUid;
                    const timeString = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'Sending...';
                    html += `<div class="chat-message ${isStudent ? 'chat-student' : 'chat-counsellor'}">${msg.text}<span class="chat-time" style="${isStudent ? 'color:rgba(255,255,255,0.7);' : ''}">${timeString}</span></div>`;
                });
            }
            chatBox.innerHTML = html; chatBox.scrollTop = chatBox.scrollHeight;
        });
    }

    window.sendStudentChatMessage = async function() {
        const input = document.getElementById('studentChatInput');
        const text = input.value.trim();
        const counsellorId = document.getElementById('studentChatSelect').value;
        if(!text) return; if(!counsellorId) return alert("Please select a counsellor.");
        input.value = ""; 
        try { await addDoc(collection(db, "chats", `${activeUserUid}_${counsellorId}`, "messages"), { text: text, senderId: activeUserUid, senderType: 'student', timestamp: serverTimestamp() }); } 
        catch(e) { console.error("Failed to send:", e); }
    }

    function renderMiniChart(score) {
        if (typeof Chart === 'undefined') return;
        const ctx = document.getElementById('miniClarityChart');
        if(!ctx) return;
        if(miniChartInstance) miniChartInstance.destroy();
        miniChartInstance = new Chart(ctx.getContext('2d'), {
            type: 'line',
            data: { labels: ['Start', 'Academics', 'Assessment', 'Now'], datasets: [{ data: [1, 3, score >= 6 ? 6 : score, score], borderColor: '#fcd34d', borderWidth: 2, pointRadius: 3, pointBackgroundColor: '#ffffff', tension: 0.4 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: {enabled: false} }, scales: { x: { display: false }, y: { display: false, min: 0, max: 10 } }, layout: { padding: 5 } }
        });
    }

    function unlockBadge(id, primaryClass, xpValue) {
        const el = document.getElementById(id);
        if(!previouslyUnlockedBadges.has(id) && !el.classList.contains(primaryClass)) {
            el.classList.add(primaryClass);
            el.style.animation = 'none';
            el.offsetHeight; 
            el.style.animation = 'badgePop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards';
            showToastNotification(`Achievement Unlocked!`, `+${xpValue} XP added to your profile.`);
            previouslyUnlockedBadges.add(id);
        }
    }

    window.calculateDynamicScore = function(data) {
        let score = 1; let xp = 10; 
        let percentProgress = 10;
        let levelName = "Level 1 - Explorer";
        let levelText = "You are beginning your career discovery journey.";
        let percentile = 82; 
        
        let focusTitle = "Complete Baseline Profile";
        let focusDesc = "Log your academic scores to help the AI contextualize your upcoming assessment.";
        let focusBtnText = "Update Academics ‚ûî";
        let focusAction = "switchTab('tab-portfolio', document.querySelectorAll('.nav-btn')[3])";

        previouslyUnlockedBadges.add('badge-registered');

        if(data.academic && (data.academic.overallScore || data.academic.stream || (data.academic.subjects && data.academic.subjects.length > 0))) { 
            score += 2; xp += 20; percentProgress = 30;
            unlockBadge('badge-academic', 'unlocked-primary', 20);
            document.getElementById('dot-portfolio').innerText = "‚úî";
            
            focusTitle = "Take Psychometric Assessment";
            focusDesc = "Takes approx 25 minutes. Essential to unlock your AI-driven matches.";
            focusBtnText = "Start Assessment ‚ûî";
            focusAction = "launchAssessment()";
        } 
        
        if(data.assessmentCompleted) { 
            score += 3; xp += 40; percentProgress = 60;
            unlockBadge('badge-assessed', 'unlocked-primary', 40);
            document.getElementById('tl-step-2').classList.add('completed');
            document.getElementById('dot-report').innerText = "‚úî";
            document.getElementById('dot-explore').innerText = "‚úî";
            
            focusTitle = "Review & Book Expert";
            focusDesc = "Review your Career Lab pathways, then book a session to discuss with a pro.";
            focusBtnText = "Book Free Session ‚ûî";
            focusAction = "switchTab('tab-counselling', document.querySelectorAll('.nav-btn')[4])";
        }

        if(data.sessionsHad && data.sessionsHad > 0) { 
            score += 2; xp += 60; percentProgress = 85;
            unlockBadge('badge-counselled', 'unlocked-primary', 60);
            document.getElementById('tl-step-3').classList.add('completed');
            document.getElementById('dot-counselling').innerText = "‚úî";
            document.getElementById('dot-chat').innerText = "‚úî";

            focusTitle = "Commit & Lock Path";
            focusDesc = "Based on your session, lock in your final choice to generate your execution plan.";
            focusBtnText = "Lock Final Path ‚ûî";
            focusAction = "document.getElementById('lockCareerSection').scrollIntoView({behavior: 'smooth'})";
        }

        if(data.careerLocked) {
            score = 10; xp += 100; percentProgress = 100;
            unlockBadge('badge-locked', 'unlocked-success', 100);
            document.getElementById('tl-step-4').classList.add('completed');
            document.getElementById('lockCareerSection').style.display = 'none'; 
            document.getElementById('careerLockedSuccess').style.display = 'block';
            lockUI();

            focusTitle = "Execute Action Plan";
            focusDesc = "Your path is set. Follow your recommended 1-Year Execution strategy.";
            focusBtnText = "View Execution Plan ‚ûî";
            focusAction = "switchTab('tab-report', document.querySelectorAll('.nav-btn')[1])";
        } else if (score >= 8) {
            document.getElementById('lockCareerSection').style.display = 'block'; document.getElementById('careerLockedSuccess').style.display = 'none';
        } else {
            document.getElementById('lockCareerSection').style.display = 'none'; document.getElementById('careerLockedSuccess').style.display = 'none';
        }

        if(score >= 10) { levelName = "Level 5 - Decided"; levelText = "Path locked. Action plan activated. Time to execute."; percentile = 95; }
        else if (score >= 8) { levelName = "Level 4 - Strategist"; levelText = "Excellent clarity! You are ready to lock your final strategic path."; percentile = 88;}
        else if (score >= 6) { levelName = "Level 3 - Analyst"; levelText = "You've moved from exploration to structured comparison."; percentile = 65;}
        else if (score >= 4) { levelName = "Level 2 - Discoverer"; levelText = "Assessment complete. Analyzing your natural aptitudes."; percentile = 40;}
        
        document.getElementById('dynLevelTitle').innerText = levelName;
        document.getElementById('dynClarityText').innerText = levelText;
        document.getElementById('dynPercentile').innerText = percentile;
        document.getElementById('dynClarityScore').innerText = score;
        document.getElementById('dynXp').innerText = xp;
        
        document.getElementById('weeklyFocusTitle').innerText = focusTitle;
        document.getElementById('weeklyFocusDesc').innerText = focusDesc;
        const fBtn = document.getElementById('weeklyFocusBtn');
        fBtn.innerText = focusBtnText;
        fBtn.setAttribute('onclick', focusAction);

        if(data.assessmentCompleted && data.fullReport) {
            document.getElementById('lockedReportUI').style.display = 'none';
            document.getElementById('unlockedReportUI').style.display = 'block';
            renderCareerLabActuals(data.fullReport);
            const rep = data.fullReport;
            document.getElementById('reportRiasecCode').innerText = rep.finalCode;
            document.getElementById('reportProfileDesc').innerText = rep.profileDesc;

            document.getElementById('reportCareersContainer').innerHTML = rep.topCareers.map(c => `
                <div class="career-pill" style="border-left: 4px solid var(--border);"><span>${c.name}</span><span class="status-pill status-success" style="font-size:0.75rem;">${c.score}% Match</span></div>
            `).join('');
            
            if(rep.topCareers && rep.topCareers.length > 0) {
                document.getElementById('dashCareersContainer').innerHTML = `
                    <div class="career-pill" style="border-left: 4px solid var(--primary);"><span>${rep.topCareers[0].name}</span> <span>üî• Strong Match</span></div>
                    <div class="career-pill" style="border-left: 4px solid var(--secondary);"><span>${rep.topCareers[1].name}</span> <span>‚≠ê Good Match</span></div>
                `;
            }

            if (typeof Chart !== 'undefined') {
                let existingChart = Chart.getChart('reportRiasecChart');
                if (existingChart) {
                    existingChart.destroy();
                }

                const reportCtx = document.getElementById('reportRiasecChart').getContext('2d');
                new Chart(reportCtx, { 
                    type: 'radar', 
                    data: { 
                        labels: ['Realistic','Investigative','Artistic','Social','Enterprising','Conventional'], 
                        datasets: [{ 
                            data: [rep.scores.R, rep.scores.I, rep.scores.A, rep.scores.S, rep.scores.E, rep.scores.C], 
                            backgroundColor: 'rgba(59, 130, 246, 0.2)', 
                            borderColor: '#3b82f6', 
                            pointBackgroundColor: '#0f172a' 
                        }] 
                    }, 
                    options: { maintainAspectRatio: false, scales: { r: { max: 100, min: 0, ticks:{display:false} } }, plugins: { legend: { display: false } } } 
                });
            }
        }

        setTimeout(() => {
            document.getElementById('dynClarityBar').style.width = (score * 10) + "%";
            document.getElementById('sideProfileBar').style.width = percentProgress + "%";
            document.getElementById('sideProfileText').innerText = percentProgress + "%";
            renderMiniChart(score);
        }, 300);
    }

    function lockUI() {
        document.getElementById('academicInputCard').style.pointerEvents = 'none';
        document.getElementById('academicInputCard').style.opacity = '0.6';
    }

    window.lockFinalCareer = async function() {
        if(!confirm("Are you sure you want to lock your career path? This will finalize your timeline and freeze comparisons.")) return;
        try { 
            await updateDoc(doc(db, "students", activeUserUid), { careerLocked: true }); 
            studentDataObj.careerLocked = true; 
            calculateDynamicScore(studentDataObj);
            
            const successBox = document.getElementById('careerLockedSuccess');
            successBox.style.animation = 'lockSuccessPop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards';
            showToastNotification("Achievement Unlocked! üèÜ", "You have officially locked your strategic career path.");
        } catch(e) { console.error(e); }
    }

    // --- NEW ACADEMIC SAVE LOGIC WITH VALIDATION ---
    window.saveAcademicPortfolio = async function() {
        if(!activeUserUid) return;
        
        const sys = document.getElementById('portGradingSystem').value;
        const scoreVal = parseFloat(document.getElementById('portOverallScore').value);

        // Score Validation
        if (!isNaN(scoreVal)) {
            if ((sys.includes('%') || sys === 'Percentile') && scoreVal > 100) {
                return alert("Score cannot be greater than 100 for Percentage or Percentile.");
            }
            if (sys.includes('4') && scoreVal > 4) {
                return alert("Score cannot be greater than 4 for a 4-point GPA system.");
            }
            if (sys.includes('10') && scoreVal > 10) {
                return alert("Score cannot be greater than 10 for a 10-point CGPA system.");
            }
        }

        // Harvest dynamic subjects
        const subjectNodes = document.querySelectorAll('.subject-row');
        let parsedSubjects = [];
        subjectNodes.forEach(node => {
            let n = node.querySelector('.sub-name').value.trim();
            let s = node.querySelector('.sub-score').value.trim();
            let g = node.querySelector('.sub-grade').value.trim();
            if(n || s) { parsedSubjects.push({ name: n, score: s, grade: g }); }
        });

        // Harvest School Details
        const isIndia = document.getElementById('portCountry').value === 'India';
        const schoolObj = {
            country: document.getElementById('portCountry').value,
            name: document.getElementById('portSchoolName').value.trim(),
            board: document.getElementById('portBoard').value,
            state: isIndia ? document.getElementById('portState').value : "",
            district: isIndia ? document.getElementById('portDistrict').value : "",
        };
        
        // Include Extra Curriculars
        const extraCurr = document.getElementById('portExtraCurricular').value.trim();

        const academicData = { 
            gradingSystem: sys,
            overallScore: isNaN(scoreVal) ? "" : scoreVal,
            trend: document.getElementById('portTrend').value,
            stream: document.getElementById('portStream').value,
            subjects: parsedSubjects,
            school: schoolObj,
            extraCurriculars: extraCurr
        };

        try {
            await setDoc(doc(db, "students", activeUserUid), { academic: academicData }, { merge: true });
            showToastNotification("Academic Profile Updated!", "Your metrics have been successfully saved.");
            if(!studentDataObj.academic) studentDataObj.academic = {};
            studentDataObj.academic = {...studentDataObj.academic, ...academicData}; 
            calculateDynamicScore(studentDataObj);
        } catch(e) { console.error(e); alert("Failed to save. Check your connection.");}
    }

    onAuthStateChanged(auth, async (user) => {
        if (!user) { window.location.href = "index.html"; return; }
        activeUserUid = user.uid;
        loadCounsellors();

        try {
            const studentSnap = await getDoc(doc(db, "students", user.uid));
            if (studentSnap.exists()) {
                const data = studentSnap.data();
                studentDataObj = data; 
                
                const firstName = data.name.split(' ')[0];
                document.getElementById('stuName').innerText = data.name;
                document.getElementById('welcomeText').innerText = `Welcome back, ${firstName}.`;
                document.getElementById('setStuName').value = data.name;
                document.getElementById('setStuEmail').value = data.email;
                
                if(data.photo) {
                    document.getElementById('stuAvatarImg').src = data.photo;
                    document.getElementById('stuAvatarImg').style.display = 'block';
                    document.getElementById('stuInitials').style.display = 'none';
                } else {
                    document.getElementById('stuInitials').innerText = firstName.charAt(0).toUpperCase();
                }
                
                // --- LOAD NEW ACADEMIC STRUCTURE ---
                if(data.academic) {
                    if(data.academic.gradingSystem) { document.getElementById('portGradingSystem').value = data.academic.gradingSystem; updateGradingInput(); }
                    if(data.academic.overallScore) document.getElementById('portOverallScore').value = data.academic.overallScore;
                    if(data.academic.trend) document.getElementById('portTrend').value = data.academic.trend;
                    if(data.academic.stream) document.getElementById('portStream').value = data.academic.stream;
                    if(data.academic.extraCurriculars) document.getElementById('portExtraCurricular').value = data.academic.extraCurriculars;
                    
                    // Legacy Fallback for older data format
                    if(!data.academic.overallScore && data.academic.marks) { document.getElementById('portOverallScore').value = data.academic.marks; }
                    
                    // Load Subjects
                    const subContainer = document.getElementById('subjectContainer');
                    subContainer.innerHTML = '';
                    if(data.academic.subjects && data.academic.subjects.length > 0) {
                        data.academic.subjects.forEach(sub => addSubjectRow(sub.name, sub.score, sub.grade));
                        // Automatically show subject section if data exists
                        document.getElementById('subjectSectionWrapper').style.display = 'block';
                        document.getElementById('toggleSubjectBtn').innerText = 'Hide Subjects ‚¨Ü';
                    } else {
                        addSubjectRow(); // Fallback empty row
                        if(data.academic.strongSub) { document.querySelector('.sub-name').value = data.academic.strongSub; }
                    }

                    // Load School
                    if(data.academic.school) {
                        document.getElementById('portCountry').value = data.academic.school.country || "India";
                        toggleLocationFields();
                        document.getElementById('portSchoolName').value = data.academic.school.name || "";
                        document.getElementById('portBoard').value = data.academic.school.board || "CBSE";
                        if(data.academic.school.state) {
                            document.getElementById('portState').value = data.academic.school.state;
                            populateDistricts(data.academic.school.district);
                        }
                    }
                } else {
                    addSubjectRow(); // Initial empty state for subjects
                }

                calculateDynamicScore(data);
            } else { window.location.href = "register.html"; }
        } catch (error) { console.error("Data load failed:", error); }
    });

    document.getElementById('logoutBtnTop').addEventListener('click', () => {
        if(confirm("Are you sure you want to log out?")) { signOut(auth).then(() => { window.location.href = "index.html"; }); }
    });
</script>
</body>
</html>
